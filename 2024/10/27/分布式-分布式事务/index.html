<!DOCTYPE html><html lang="zn-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>分布式-分布式事务 | XIAOYAN</title><meta name="keywords" content="分布式事务"><meta name="author" content="xiaoyan"><meta name="copyright" content="xiaoyan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="分布式-分布式事务"><meta name="application-name" content="分布式-分布式事务"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="分布式-分布式事务"><meta property="og:url" content="http://example.com/2024/10/27/%E5%88%86%E5%B8%83%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/index.html"><meta property="og:site_name" content="XIAOYAN"><meta property="og:description" content="事务为什么需要事务？在复杂的系统操作中，数据一致性是一个关键问题。例如，在转账场景中，A向B转账100元，执行顺序为先扣除A账户中的100元，再向B账户中增加100元。如果系统在扣除A账户的100元后突然宕机，B账户并未增加100元，这将导致数据不一致。为了解决这类问题，事务机制应运而生。事务确保一"><meta property="og:locale" content="zn-CN"><meta property="og:image" content="https://xiaoyanfufu-io.oss-cn-guangzhou.aliyuncs.com/blog/202410281041645.png"><meta property="article:author" content="xiaoyan"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://xiaoyanfufu-io.oss-cn-guangzhou.aliyuncs.com/blog/202410281041645.png"><meta name="description" content="事务为什么需要事务？在复杂的系统操作中，数据一致性是一个关键问题。例如，在转账场景中，A向B转账100元，执行顺序为先扣除A账户中的100元，再向B账户中增加100元。如果系统在扣除A账户的100元后突然宕机，B账户并未增加100元，这将导致数据不一致。为了解决这类问题，事务机制应运而生。事务确保一"><link rel="shortcut icon" href="/images/favicon.ico"><link rel="canonical" href="http://example.com/2024/10/27/%E5%88%86%E5%B8%83%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: {"enable":true,"img":"https://upload-bbs.miyoushe.com/upload/2024/07/27/125766904/ba62475f396df9de3316a08ed9e65d86_5680958632268053399..png"},
  postHeadAiDescription: undefined,
  diytitle: undefined,
  LA51: undefined,
  greetingBox: undefined,
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: undefined,
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: xiaoyan","link":"链接: ","source":"来源: XIAOYAN","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'XIAOYAN',
  title: '分布式-分布式事务',
  postAI: '',
  pageFillDescription: '事务, 为什么需要事务？, 数据库事务, 数据库事务实现原理, 事务隔离级别, 分布式事务, 分布式事务解决方案, 刚性事务, 2PC（二阶段提交协议）, 准备阶段（Prepare）, 提交阶段（Commit Phase）, 总结, 3PC（三阶段提交协议）, 准备阶段（CanCommit Phase）, 预提交阶段（PreCommit Phase）, 执行事务提交阶段（DoCommit Phase）, 总结, 柔性事务, TCC（补偿事务）, 尝试阶段（Try Phase）, 确认阶段（Confirm Phase）, 取消阶段（Cancel Phase）, 失败处理与重试机制, 事务日志的管理, 业务侵入性, MQ事务, RocketMQ 事务消息, 事务消息的基本流程, 失败处理与事务反查机制, 消息消费失败处理, QMQ 事务消息, 本地消息表方案, 优点与适用场景事务为什么需要事务在复杂的系统操作中数据一致性是一个关键问题例如在转账场景中向转账元执行顺序为先扣除账户中的元再向账户中增加元如果系统在扣除账户的元后突然宕机账户并未增加元这将导致数据不一致为了解决这类问题事务机制应运而生事务确保一组操作要么全部完成要么全部不完成从而保证数据的一致性和完整性数据库事务在日常开发中特别是在单体架构中数据库事务是最常见的事务类型数据库事务可以保证多个数据库操作作为一个逻辑上的整体来执行遵循要么全部完成要么全部不完成的原则开启事务多条语句提交事务数据库事务具有特性确保数据的可靠性和一致性原子性事务是最小的执行单位不可分割事务的原子性确保动作要么全部完成要么全部失败一致性执行事务前后数据要保持一致例如在转账事务中无论转账成功与否转账者和收款者的总额应保持不变隔离性并发数据库访问时一个事务不会影响另外一个事务事务之间是独立的持久性一个事务被提交之后在数据库中的修改是永久的即使数据库发生故障也不会对其有任何影响需要注意的是是实现手段而是最终目的数据库事务实现原理默认的引擎通过以下机制实现事务的特性原子性通过回滚日志来保证记录了事务执行前的数据状态如果事务执行过程中发生错误可以通过回滚到事务开始前的状态持久性通过重做日志来保证记录了事务执行后的数据状态即使数据库发生故障也可以通过恢复到事务提交后的状态隔离性通过锁机制和多版本并发控制来保证锁机制确保事务在执行过程中不会被其他事务干扰通过为每个事务创建一个版本号确保事务之间的数据隔离一致性通过上述机制的协同作用确保事务执行前后数据的一致性事务隔离级别默认的事务隔离级别是可重复读不同的隔离级别会影响事务的并发性能和数据一致性读未提交最低的隔离级别事务可以读取到其他事务未提交的数据可能导致脏读不可重复读和幻读读已提交事务只能读取到其他事务已提交的数据避免了脏读但可能出现不可重复读和幻读可重复读事务在执行过程中多次读取同一数据时结果保持一致避免了不可重复读但可能出现幻读串行化最高的隔离级别事务串行执行避免了所有并发问题但性能最低通过理解事务的特性和实现原理开发人员可以更好地设计和实现可靠的数据库操作确保系统的数据一致性和稳定性分布式事务在微服务架构下一个系统被拆分为多个小的微服务每个微服务可能存在不同的服务器上并且每个微服务可能都有一个单独的数据库供自己使用这种情况下一组操作可能涉及多个微服务以及多个数据库例如在电商系统中创建一个订单一般会涉及到两个表以上的操作订单表加库存表减而订单表和库存表可能分别存放在不同服务器的数据库中这种场景下想要保证数据的一致性应该如何实现此时想通过数据库自带的事务管理可能不太够用了需要通过分布式事务来实现涉及在不同的数据库进行操作时都应该引入分布式事务比如在单个数据库的性能达到瓶颈或数据量过大时我们需要进行分库分库之后同一个数据库的表数据分布在了不同的表中分布式事务的最终目的也就是保证多个相关联的数据库之间的数据保持一致按道理来说既然是保证一致性那么应该也是保证特性但由于性能可用性等方面考虑分布式事务往往无法保证而只能选择一个比较折中的方案分布式事务解决方案刚性事务在互联网分布式场景中某些关键业务场景要求数据具备强一致性因此需要采用能够保证这种特性的解决方案这类解决方案被称为刚性事务常见的刚性事务解决方案包括两阶段提交三阶段提交等和属于业务代码无侵入式的解决方案它们都是基于规范衍生出来的实现规范是由组织提出的分布式事务处理标准定义了分布式事务管理器和资源管理器之间的接口应用程序本身资源管理器是事务的参与者绝大多数情况下指代的都是数据库一个分布式事务通常涉及多个事务管理器协调者负责管理全局事务分配事务唯一标识符监控事务的执行进度并负责事务的提交回滚失败恢复等二阶段提交协议即两阶段提交协议是一种经典的分布式事务协议旨在确保分布式系统中的多个节点在事务提交或回滚时保持一致性分为两个阶段准备阶段和提交阶段准备阶段准备阶段的核心目标是确认所有事务参与者是否能够成功执行本地数据库操作准备阶段的工作流程如下询问阶段事务管理者协调者向所有涉及到事务的参与者发送询问消息询问它们是否可以执行事务操作并等待的回复执行阶段接收到询问消息后执行本地事务操作如写入等此时事务尚未提交如果能够成功执行事务操作则向响应表示已就绪如果事务执行失败则响应表示未就绪提交阶段提交阶段的核心目标是确认所有事务参与者是否能够成功提交本地事务当准备阶段的所有参与者都响应已就绪状态给时进入事务提交阶段提交指令向所有发送指令表示可以进行事务提交提交事务接收到指令后开始提交本地事务并释放占用的数据库资源确认提交提交事务后向回复确认消息表示事务已完成提交事务结束收到所有的确认消息后整个分布式事务正式结束然而如果在提交阶段有部分参与者响应未就绪状态则表示有部分事务执行失败根据事务的原子性原则此时需要进行事务回滚回滚指令向所有发送指令表示需要进行事务回滚回滚事务接收到指令后开始回滚本地事务并释放占用的数据库资源确认回滚回滚事务后向回复确认消息表示事务回滚已完成事务中断收到所有的确认消息后中断整个事务总结的准备阶段旨在确认所有参与者是否能够执行事务操作提交阶段则确认参与者的事务提交状态提交阶段的结果由准备阶段决定是进行提交还是进行回滚的优点简单易实现的实现相对简单易于理解和部署强一致性能够确保事务的强一致性适用于对数据一致性要求极高的场景的缺点同步阻塞由于需要保持强一致性在事务期间会占用资源导致其他事务被阻塞降低了系统的可用性数据不一致如果在事务过程中突然宕机可能会导致部分参与者已经提交事务而其他参与者尚未提交从而引发数据不一致问题单点故障在中扮演着至关重要的角色如果宕机其他将无法继续进行事务操作导致系统停滞三阶段提交协议是对的改进通过引入一个预提交阶段来减少阻塞问题并提高系统的可用性将事务的准备阶段分为两个部分准备阶段和预提交阶段再加上最终的提交阶段准备阶段准备阶段的核心目的是确认所有参与者的响应能力和是否能够执行本地数据库事务操作准备阶段的工作流程如下询问阶段事务管理者协调者向所有发送询问消息询问它们是否能够执行事务操作并等待的回复响应阶段接收到询问消息后不会执行实际的事务操作而是根据自身状态判断是否能够执行事务如果能够执行事务操作则向响应表示可以执行如果不能执行事务操作则响应表示不能执行如果超时未响应也会认为不能执行事务预提交阶段如果准备阶段中所有的都回复了则进入预提交阶段预提交阶段的核心目的是让执行本地事务操作但并不提交事务预提交阶段的工作流程如下预提交指令向所有发送指令表示可以执行本地事务操作但不要提交执行事务操作接收到指令后执行本地事务操作但并不提交事务如果成功执行事务操作则向响应表示事务执行完毕如果执行事务操作失败则响应表示事务执行失败超时机制在预提交阶段和都引入了超时机制如果在一定时间内未收到的响应或者在执行事务操作时超时都会触发事务回滚以解除资源占用避免事务阻塞执行事务提交阶段进行真正的事务提交如果在预提交阶段收到了所有响应则进入最终的提交阶段提交阶段的工作流程如下提交指令向所有发送指令表示可以进行事务提交提交事务接收到指令后提交本地数据库事务并释放占用的资源确认提交提交事务后向回复确认消息表示事务已完成提交事务结束收到所有的确认消息后整个事务正式结束如果在预提交阶段有任一响应或者超时未响应会向所有发送指令中断事务此时中断事务的损失对来说并不大因为事务还未进行提交总结通过引入预提交阶段减少了中的阻塞问题并提高了系统的可用性的工作流程如下确认的响应能力和是否能够执行事务操作执行本地事务操作但并不提交引入超时机制以避免阻塞进行真正的事务提交确保所有都成功提交事务的优点减少阻塞通过引入预提交阶段减少了中的阻塞问题提高了系统的可用性超时机制引入了超时机制避免了因单点故障导致的事务阻塞的缺点复杂性增加相较于的实现更为复杂增加了系统的复杂性性能开销由于引入了额外的阶段和超时机制的性能开销相对较大柔性事务基于分布式系统的理论与理论日常的分布式架构下更多需要保证的是整体系统的可用性在数据的一致性方面可以进行一定的妥协更多采用的是最终一致性方案此类方案称为柔性事务常见的柔性事务解决方案包括补偿事务消息队列事务事务等补偿事务是一种补偿型事务模型它将事务分为三个阶段尝试阶段确认阶段和取消阶段通过显式地定义事务的尝试确认和取消逻辑来实现分布式事务的最终一致性尝试阶段尝试阶段的核心目标是尝试执行事务操作并准备好业务所需的资源尝试阶段的工作流程如下业务检查业务系统进行必要的业务检查确保事务操作可以执行资源预留业务系统预留必要的资源如数据库锁缓存资源等但并不提交事务确认阶段确认阶段的核心目标是确认执行事务操作并处理尝试阶段预留的业务资源确认阶段的工作流程如下确认执行当所有参与者的尝试阶段都执行成功后事务协调者向所有参与者发送确认指令资源提交参与者接收到确认指令后提交事务并释放预留的资源取消阶段取消阶段的核心目标是取消执行事务操作并释放尝试阶段预留的资源取消阶段的工作流程如下取消执行如果任何一个参与者的尝试阶段执行失败或者在确认阶段出现失败事务协调者向所有参与者发送取消指令资源释放参与者接收到取消指令后回滚事务并释放预留的资源失败处理与重试机制在的确认阶段或取消阶段如果出现失败会记录事务日志并持久化到某种存储介质上如本地磁盘文件或关系型数据库等事务日志包含了事务的执行状态如果检测到在确认或取消阶段执行事务出现失败状态会进行重试该阶段的事务逻辑重试次数一般为次若超过重试次数仍然失败则需要人工介入处理事务日志的管理事务日志在事务执行成功后可以被删除以节省资源事务日志的管理通常由事务协调者负责确保在事务成功提交后清理相关日志业务侵入性不需要依赖于底层的数据库资源更多地是需要手动实现事务的尝试确认和取消逻辑因此属于业务侵入式分布式事务解决方案开发人员需要在业务代码中显式地实现的三个阶段增加了开发复杂度但同时也提供了更高的灵活性和控制力事务消息队列事务允许事务流应用将生产处理消费消息的整个过程看作是一个原子操作常见的消息队列系统如等都提供了事务相关的功能下面以为例详细介绍事务的工作原理和处理机制事务消息的事务消息机制采用了类似于两阶段提交的流程确保消息的生产和消费过程的原子性事务消息的基本流程发送半事务消息生产者在消息队列中开启一个事务然后发送半事务消息给的此时半事务消息对于消费者来说是不可见的接收到半事务消息后响应半事务消息发送成功信息给生产者执行本地事务生产者收到的发送成功响应后开始执行本地事务操作根据本地事务的执行状态生产者决定向发送或指令提交或回滚事务消息如果生产者发送指令将半事务消息转换为真正的消息并投递给消费者进行消费如果生产者发送指令将丢弃该半事务消息不进行投递失败处理与事务反查机制如果在第步生产者发送或消息失败了的会定期查询生产者对应事务的本地事务执行情况并根据反查结果决定提交或回滚这个半事务消息事务反查机制的实现依赖于业务代码实现的对应接口提供了事务反查的回调接口业务系统需要实现该接口以便在需要时查询本地事务的状态消息消费失败处理如果消息消费失败会进入消息重试机制再次尝试消费消息如果消息重试超过了最大次数会认为这个消费有问题然后将其放入死信队列中由人工手动排查处理事务消息的事务消息机制相对简单它借助了数据库自带的事务功能采用了类似于提出的本地消息表方案将分布式事务拆分成本地事务进行处理本地消息表方案业务操作与消息表写入业务系统在执行本地事务操作的同时将消息发送状态写入本地消息表这两个操作在一个事务中提交确保业务操作成功时消息表也写入成功消息发送单独起一个线程定时轮询消息表将未处理的消息发送到消息中间件如等消息发送成功后更新消息状态为成功或直接删除消息优点与适用场景的事务消息方案中即使消息队列挂掉也不会影响数据库事务的执行因此更加适应于大多数业务场景这种方法同样适用于其他消息队列只是封装得更好提供了开箱即用的解决方案',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-04 11:40:02',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="/images/star.png"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><a id="site-name" href="/" accesskey="h"><div class="title">XIAOYAN</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=12613265870&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AOP/" style="font-size: 1.05rem;">AOP<sup>1</sup></a><a href="/tags/Bean/" style="font-size: 1.05rem;">Bean<sup>1</sup></a><a href="/tags/DDD/" style="font-size: 1.05rem;">DDD<sup>1</sup></a><a href="/tags/IoC/" style="font-size: 1.05rem;">IoC<sup>1</sup></a><a href="/tags/Java8%E6%96%B0%E7%89%B9%E6%80%A7/" style="font-size: 1.05rem;">Java8新特性<sup>1</sup></a><a href="/tags/Java%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" style="font-size: 1.05rem;">Java基本概念<sup>1</sup></a><a href="/tags/List/" style="font-size: 1.05rem;">List<sup>1</sup></a><a href="/tags/Map/" style="font-size: 1.05rem;">Map<sup>2</sup></a><a href="/tags/MyBatis/" style="font-size: 1.05rem;">MyBatis<sup>1</sup></a><a href="/tags/MySQL%E5%9F%BA%E7%A1%80/" style="font-size: 1.05rem;">MySQL基础<sup>1</sup></a><a href="/tags/Object/" style="font-size: 1.05rem;">Object<sup>1</sup></a><a href="/tags/SQL%E8%B0%83%E4%BC%98/" style="font-size: 1.05rem;">SQL调优<sup>1</sup></a><a href="/tags/Set/" style="font-size: 1.05rem;">Set<sup>1</sup></a><a href="/tags/SpringBoot/" style="font-size: 1.05rem;">SpringBoot<sup>1</sup></a><a href="/tags/SpringCloud/" style="font-size: 1.05rem;">SpringCloud<sup>1</sup></a><a href="/tags/%E4%BA%8B%E5%8A%A1/" style="font-size: 1.05rem;">事务<sup>2</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" style="font-size: 1.05rem;">内存模型<sup>1</sup></a><a href="/tags/%E5%8F%8D%E5%B0%84/" style="font-size: 1.05rem;">反射<sup>1</sup></a><a href="/tags/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" style="font-size: 1.05rem;">垃圾回收<sup>1</sup></a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 1.05rem;">多线程<sup>1</sup></a><a href="/tags/%E5%AF%B9%E8%B1%A1/" style="font-size: 1.05rem;">对象<sup>1</sup></a><a href="/tags/%E5%B9%B6%E5%8F%91%E5%AE%89%E5%85%A8/" style="font-size: 1.05rem;">并发安全<sup>1</sup></a><a href="/tags/%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 1.05rem;">序列化<sup>1</sup></a><a href="/tags/%E5%BC%82%E5%B8%B8/" style="font-size: 1.05rem;">异常<sup>1</sup></a><a href="/tags/%E6%8B%B7%E8%B4%9D/" style="font-size: 1.05rem;">拷贝<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" style="font-size: 1.05rem;">数据类型<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 1.05rem;">数据结构<sup>1</sup></a><a href="/tags/%E6%97%A5%E5%BF%97/" style="font-size: 1.05rem;">日志<sup>2</sup></a><a href="/tags/%E6%9F%A5%E8%AF%A2/" style="font-size: 1.05rem;">查询<sup>1</sup></a><a href="/tags/%E6%B3%9B%E5%9E%8B/" style="font-size: 1.05rem;">泛型<sup>1</sup></a><a href="/tags/%E6%B3%A8%E8%A7%A3/" style="font-size: 1.05rem;">注解<sup>1</sup></a><a href="/tags/%E7%AD%96%E7%95%A5/" style="font-size: 1.05rem;">策略<sup>1</sup></a><a href="/tags/%E7%B1%BB%E5%88%9D%E5%A7%8B%E5%8C%96/" style="font-size: 1.05rem;">类初始化<sup>1</sup></a><a href="/tags/%E7%B1%BB%E5%8A%A0%E8%BD%BD/" style="font-size: 1.05rem;">类加载<sup>1</sup></a><a href="/tags/%E7%B4%A2%E5%BC%95/" style="font-size: 1.05rem;">索引<sup>2</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/" style="font-size: 1.05rem;">线程模型<sup>1</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" style="font-size: 1.05rem;">线程池<sup>1</sup></a><a href="/tags/%E9%94%81/" style="font-size: 1.05rem;">锁<sup>2</sup></a><a href="/tags/%E9%9B%86%E7%BE%A4/" style="font-size: 1.05rem;">集群<sup>1</sup></a><a href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" style="font-size: 1.05rem;">面向对象<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/11/"><span class="card-archive-list-date">November 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/10/"><span class="card-archive-list-date">October 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">13</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">September 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">25</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/07/"><span class="card-archive-list-date">July 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url">分布式</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>分布式事务</span></a></span></div></div><h1 class="post-title" itemprop="name headline">分布式-分布式事务</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-10-27T13:08:20.000Z" title="发表于 2024-10-27 21:08:20">2024-10-27</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2024-11-04T03:40:02.448Z" title="更新于 2024-11-04 11:40:02">2024-11-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为桂林"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>桂林</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://xiaoyanfufu-io.oss-cn-guangzhou.aliyuncs.com/blog/202410281041645.png"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://example.com/2024/10/27/%E5%88%86%E5%B8%83%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"><header><a class="post-meta-categories" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="url">分布式</a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" tabindex="-1" itemprop="url">分布式事务</a><h1 id="CrawlerTitle" itemprop="name headline">分布式-分布式事务</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">xiaoyan</span><time itemprop="dateCreated datePublished" datetime="2024-10-27T13:08:20.000Z" title="发表于 2024-10-27 21:08:20">2024-10-27</time><time itemprop="dateCreated datePublished" datetime="2024-11-04T03:40:02.448Z" title="更新于 2024-11-04 11:40:02">2024-11-04</time></header><h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><h2 id="为什么需要事务？"><a href="#为什么需要事务？" class="headerlink" title="为什么需要事务？"></a>为什么需要事务？</h2><p>在复杂的系统操作中，数据一致性是一个关键问题。例如，在转账场景中，A向B转账100元，执行顺序为先扣除A账户中的100元，再向B账户中增加100元。如果系统在扣除A账户的100元后突然宕机，B账户并未增加100元，这将导致数据不一致。为了解决这类问题，事务机制应运而生。事务确保一组操作要么全部完成，要么全部不完成，从而保证数据的一致性和完整性。</p>
<h2 id="数据库事务"><a href="#数据库事务" class="headerlink" title="数据库事务"></a>数据库事务</h2><p>在日常开发中，特别是在单体架构中，<strong>数据库事务</strong>是最常见的事务类型。数据库事务可以保证多个数据库操作作为一个逻辑上的整体来执行，遵循“要么全部完成，要么全部不完成”的原则。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 开启事务</span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"># 多条<span class="keyword">SQL</span>语句</span><br><span class="line">...</span><br><span class="line"># 提交事务</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<p>数据库事务具有ACID特性，确保数据的可靠性和一致性：</p>
<ul>
<li><strong>原子性（Atomicity）</strong>：事务是最小的执行单位，不可分割。事务的原子性确保动作要么全部完成，要么全部失败。</li>
<li><strong>一致性（Consistency）</strong>：执行事务前后，数据要保持一致。例如，在转账事务中，无论转账成功与否，转账者和收款者的总额应保持不变。</li>
<li><strong>隔离性（Isolation）</strong>：并发数据库访问时，一个事务不会影响另外一个事务，事务之间是独立的。</li>
<li><strong>持久性（Durability）</strong>：一个事务被提交之后，在数据库中的修改是永久的，即使数据库发生故障也不会对其有任何影响。</li>
</ul>
<p>需要注意的是，A、I、D是实现手段，而C是最终目的。</p>
<h3 id="数据库事务实现原理"><a href="#数据库事务实现原理" class="headerlink" title="数据库事务实现原理"></a>数据库事务实现原理</h3><p>MySQL默认的InnoDB引擎通过以下机制实现事务的ACID特性：</p>
<ul>
<li><strong>原子性（Atomicity）</strong>：通过undo log（回滚日志）来保证。undo log记录了事务执行前的数据状态，如果事务执行过程中发生错误，可以通过undo log回滚到事务开始前的状态。</li>
<li><strong>持久性（Durability）</strong>：通过redo log（重做日志）来保证。redo log记录了事务执行后的数据状态，即使数据库发生故障，也可以通过redo log恢复到事务提交后的状态。</li>
<li><strong>隔离性（Isolation）</strong>：通过锁机制和MVCC（多版本并发控制）来保证。锁机制确保事务在执行过程中不会被其他事务干扰，MVCC通过为每个事务创建一个版本号，确保事务之间的数据隔离。</li>
<li><strong>一致性（Consistency）</strong>：通过上述机制的协同作用，确保事务执行前后数据的一致性。</li>
</ul>
<h3 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h3><p>MySQL默认的事务隔离级别是Repeatable-read（可重复读），不同的隔离级别会影响事务的并发性能和数据一致性：</p>
<ul>
<li><strong>Read Uncommitted（读未提交）</strong>：最低的隔离级别，事务可以读取到其他事务未提交的数据，可能导致脏读、不可重复读和幻读。</li>
<li><strong>Read Committed（读已提交）</strong>：事务只能读取到其他事务已提交的数据，避免了脏读，但可能出现不可重复读和幻读。</li>
<li><strong>Repeatable Read（可重复读）</strong>：事务在执行过程中多次读取同一数据时，结果保持一致，避免了不可重复读，但可能出现幻读。</li>
<li><strong>Serializable（串行化）</strong>：最高的隔离级别，事务串行执行，避免了所有并发问题，但性能最低。</li>
</ul>
<p>通过理解事务的ACID特性和实现原理，开发人员可以更好地设计和实现可靠的数据库操作，确保系统的数据一致性和稳定性。</p>
<h2 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h2><p>在微服务架构下，一个系统被拆分为多个小的微服务，每个微服务可能存在不同的服务器上，并且每个微服务可能都有一个单独的数据库供自己使用。这种情况下，一组操作可能涉及多个微服务以及多个数据库。</p>
<p>例如，在电商系统中，创建一个订单一般会涉及到两个表以上的操作：订单表加1，库存表减1。而订单表和库存表可能分别存放在不同服务器的数据库中。这种场景下想要保证数据的一致性，应该如何实现？</p>
<p>此时，想通过数据库自带的事务管理可能不太够用了，需要通过<strong>分布式事务</strong>来实现。</p>
<p>涉及在不同的数据库进行操作时，都应该引入分布式事务。比如在单个数据库的性能达到瓶颈或数据量过大时，我们需要进行分库，分库之后，同一个数据库的表数据分布在了不同的表中。</p>
<p>分布式事务的最终目的，也就是保证多个相关联的数据库之间的数据保持一致。按道理来说既然是保证一致性，那么应该也是保证ACID特性。但由于性能、可用性等方面考虑，分布式事务往往无法保证ACID，而只能选择一个比较折中的方案。</p>
<h1 id="分布式事务解决方案"><a href="#分布式事务解决方案" class="headerlink" title="分布式事务解决方案"></a>分布式事务解决方案</h1><h2 id="刚性事务"><a href="#刚性事务" class="headerlink" title="刚性事务"></a>刚性事务</h2><p>在互联网分布式场景中，某些关键业务场景要求数据具备强一致性，因此需要采用能够保证这种特性的解决方案，这类解决方案被称为刚性事务。常见的刚性事务解决方案包括两阶段提交（2PC）、三阶段提交（3PC）等。</p>
<p>2PC 和 3PC 属于业务代码无侵入式的解决方案，它们都是基于 XA 规范衍生出来的实现。</p>
<p>XA 规范是由 X&#x2F;Open 组织提出的分布式事务处理标准，定义了分布式事务管理器（Transaction Manager, TM）和资源管理器（Resource Manager, RM）之间的接口：</p>
<ul>
<li>AP（Application Program）：应用程序本身。</li>
<li>RM（Resource Manager）：资源管理器，是事务的参与者，绝大多数情况下指代的都是数据库，一个分布式事务通常涉及多个RM。</li>
<li>TM（Transaction Manager）：事务管理器&#x2F;协调者，负责管理全局事务，分配事务唯一标识符，监控事务的执行进度，并负责事务的提交、回滚、失败恢复等。</li>
</ul>
<h3 id="2PC（二阶段提交协议）"><a href="#2PC（二阶段提交协议）" class="headerlink" title="2PC（二阶段提交协议）"></a>2PC（二阶段提交协议）</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://xiaoyanfufu-io.oss-cn-guangzhou.aliyuncs.com/blog/202410281041645.png" alt="2PC"></p>
<p>2PC（Two-Phase Commit），即两阶段提交协议，是一种经典的分布式事务协议，旨在确保分布式系统中的多个节点在事务提交或回滚时保持一致性。2PC 分为两个阶段：准备阶段（Prepare Phase）和提交阶段（Commit Phase）。</p>
<h4 id="准备阶段（Prepare）"><a href="#准备阶段（Prepare）" class="headerlink" title="准备阶段（Prepare）"></a>准备阶段（Prepare）</h4><p>准备阶段的核心目标是确认所有事务参与者是否能够成功执行本地数据库操作。</p>
<p>准备阶段的工作流程如下：</p>
<ol>
<li><strong>询问阶段</strong>：事务管理者&#x2F;协调者（Transaction Manager, TM）向所有涉及到事务的参与者（Resource Manager, RM）发送询问消息，询问它们是否可以执行事务操作，并等待 RM 的回复。</li>
<li><strong>执行阶段</strong>：RM 接收到询问消息后，执行本地事务操作，如写入 redo log、undo log 等。此时，事务尚未提交。如果 RM 能够成功执行事务操作，则向 TM 响应“Yes”表示已就绪；如果事务执行失败，则响应“No”表示未就绪。</li>
</ol>
<h4 id="提交阶段（Commit-Phase）"><a href="#提交阶段（Commit-Phase）" class="headerlink" title="提交阶段（Commit Phase）"></a>提交阶段（Commit Phase）</h4><p>提交阶段的核心目标是确认所有事务参与者是否能够成功提交本地事务。</p>
<p>当准备阶段的所有参与者都响应“已就绪”状态给 TM 时，进入事务提交阶段：</p>
<ol>
<li><strong>提交指令</strong>：TM 向所有 RM 发送“Commit”指令，表示 RM 可以进行事务提交。</li>
<li><strong>提交事务</strong>：RM 接收到“Commit”指令后，开始提交本地事务，并释放占用的数据库资源。</li>
<li><strong>确认提交</strong>：RM 提交事务后，向 TM 回复“ACK”确认消息，表示事务已完成提交。</li>
<li><strong>事务结束</strong>：TM 收到所有 RM 的确认消息后，整个分布式事务正式结束。</li>
</ol>
<p>然而，如果在提交阶段有部分参与者响应“未就绪”状态，则表示有部分事务执行失败。根据事务的原子性原则，此时需要进行事务回滚：</p>
<ol>
<li><strong>回滚指令</strong>：TM 向所有 RM 发送“Rollback”指令，表示 RM 需要进行事务回滚。</li>
<li><strong>回滚事务</strong>：RM 接收到“Rollback”指令后，开始回滚本地事务，并释放占用的数据库资源。</li>
<li><strong>确认回滚</strong>：RM 回滚事务后，向 TM 回复“ACK”确认消息，表示事务回滚已完成。</li>
<li><strong>事务中断</strong>：TM 收到所有 RM 的确认消息后，中断整个事务。</li>
</ol>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>2PC 的准备阶段旨在确认所有参与者是否能够执行事务操作；提交阶段则确认参与者的事务提交状态。提交阶段的结果由准备阶段决定，是进行提交还是进行回滚。</p>
<p>2PC 的优点：</p>
<ul>
<li><strong>简单易实现</strong>：2PC 的实现相对简单，易于理解和部署。</li>
<li><strong>强一致性</strong>：2PC 能够确保事务的强一致性，适用于对数据一致性要求极高的场景。</li>
</ul>
<p>2PC 的缺点：</p>
<ul>
<li><strong>同步阻塞</strong>：由于需要保持强一致性，2PC 在事务期间会占用资源，导致其他事务被阻塞，降低了系统的可用性。</li>
<li><strong>数据不一致</strong>：如果 TM 在事务过程中突然宕机，可能会导致部分参与者已经提交事务，而其他参与者尚未提交，从而引发数据不一致问题。</li>
<li><strong>单点故障</strong>：TM 在 2PC 中扮演着至关重要的角色，如果 TM 宕机，其他 RM 将无法继续进行事务操作，导致系统停滞。</li>
</ul>
<h3 id="3PC（三阶段提交协议）"><a href="#3PC（三阶段提交协议）" class="headerlink" title="3PC（三阶段提交协议）"></a>3PC（三阶段提交协议）</h3><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://xiaoyanfufu-io.oss-cn-guangzhou.aliyuncs.com/blog/202410281126640.png" alt="3PC" style="zoom:67%;">

<p>3PC（Three-Phase Commit）是对 2PC 的改进，通过引入一个预提交阶段（PreCommit Phase）来减少阻塞问题，并提高系统的可用性。3PC 将事务的准备阶段分为两个部分：准备阶段（CanCommit Phase）和预提交阶段（PreCommit Phase），再加上最终的提交阶段（DoCommit Phase）。</p>
<h4 id="准备阶段（CanCommit-Phase）"><a href="#准备阶段（CanCommit-Phase）" class="headerlink" title="准备阶段（CanCommit Phase）"></a>准备阶段（CanCommit Phase）</h4><p>准备阶段（CanCommit Phase）的核心目的是确认所有参与者（Resource Manager, RM）的响应能力和是否能够执行本地数据库事务操作。</p>
<p>准备阶段的工作流程如下：</p>
<ol>
<li><strong>询问阶段</strong>：事务管理者&#x2F;协调者（Transaction Manager, TM）向所有 RM 发送“CanCommit”询问消息，询问它们是否能够执行事务操作，并等待 RM 的回复。</li>
<li><strong>响应阶段</strong>：RM 接收到“CanCommit”询问消息后，不会执行实际的事务操作，而是根据自身状态判断是否能够执行事务。如果 RM 能够执行事务操作，则向 TM 响应“Yes”表示可以执行；如果 RM 不能执行事务操作，则响应“No”表示不能执行；如果 RM 超时未响应，TM 也会认为 RM 不能执行事务。</li>
</ol>
<h4 id="预提交阶段（PreCommit-Phase）"><a href="#预提交阶段（PreCommit-Phase）" class="headerlink" title="预提交阶段（PreCommit Phase）"></a>预提交阶段（PreCommit Phase）</h4><p>如果准备阶段中所有的 RM 都回复了“Yes”，则进入预提交阶段（PreCommit Phase）。预提交阶段的核心目的是让 RM 执行本地事务操作，但并不提交事务。</p>
<p>预提交阶段的工作流程如下：</p>
<ol>
<li><strong>预提交指令</strong>：TM 向所有 RM 发送“PreCommit”指令，表示 RM 可以执行本地事务操作，但不要提交。</li>
<li><strong>执行事务操作</strong>：RM 接收到“PreCommit”指令后，执行本地事务操作，但并不提交事务。如果 RM 成功执行事务操作，则向 TM 响应“Yes”表示事务执行完毕；如果 RM 执行事务操作失败，则响应“No”表示事务执行失败。</li>
<li><strong>超时机制</strong>：在预提交阶段，TM 和 RM 都引入了超时机制。如果 TM 在一定时间内未收到 RM 的响应，或者 RM 在执行事务操作时超时，都会触发事务回滚，以解除资源占用，避免事务阻塞。</li>
</ol>
<h4 id="执行事务提交阶段（DoCommit-Phase）"><a href="#执行事务提交阶段（DoCommit-Phase）" class="headerlink" title="执行事务提交阶段（DoCommit Phase）"></a>执行事务提交阶段（DoCommit Phase）</h4><p>进行真正的事务提交。</p>
<p>如果 TM 在预提交阶段收到了所有 RM 响应“Yes”，则进入最终的提交阶段（DoCommit Phase）。</p>
<p>提交阶段的工作流程如下：</p>
<ol>
<li><strong>提交指令</strong>：TM 向所有 RM 发送“DoCommit”指令，表示 RM 可以进行事务提交。</li>
<li><strong>提交事务</strong>：RM 接收到“DoCommit”指令后，提交本地数据库事务，并释放占用的资源。</li>
<li><strong>确认提交</strong>：RM 提交事务后，向 TM 回复“Committed”确认消息，表示事务已完成提交。</li>
<li><strong>事务结束</strong>：TM 收到所有 RM 的“Committed”确认消息后，整个 3PC 事务正式结束。</li>
</ol>
<p>如果在预提交阶段有任一 RM 响应“No”或者超时未响应，TM 会向所有 RM 发送“Abort”指令，中断事务。此时中断事务的损失对 RM 来说并不大，因为事务还未进行提交。</p>
<h4 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h4><p>3PC 通过引入预提交阶段，减少了 2PC 中的阻塞问题，并提高了系统的可用性。3PC 的工作流程如下：</p>
<ol>
<li><strong>CanCommit Phase</strong>：确认 RM 的响应能力和是否能够执行事务操作。</li>
<li><strong>PreCommit Phase</strong>：RM 执行本地事务操作，但并不提交，引入超时机制以避免阻塞。</li>
<li><strong>DoCommit Phase</strong>：进行真正的事务提交，确保所有 RM 都成功提交事务。</li>
</ol>
<p>3PC 的优点：</p>
<ul>
<li><strong>减少阻塞</strong>：通过引入预提交阶段，减少了 2PC 中的阻塞问题，提高了系统的可用性。</li>
<li><strong>超时机制</strong>：引入了超时机制，避免了因单点故障导致的事务阻塞。</li>
</ul>
<p>3PC 的缺点：</p>
<ul>
<li><strong>复杂性增加</strong>：相较于 2PC，3PC 的实现更为复杂，增加了系统的复杂性。</li>
<li><strong>性能开销</strong>：由于引入了额外的阶段和超时机制，3PC 的性能开销相对较大。</li>
</ul>
<h2 id="柔性事务"><a href="#柔性事务" class="headerlink" title="柔性事务"></a>柔性事务</h2><p>基于分布式系统的 CAP 理论与 BASE 理论，日常的分布式架构下更多需要保证的是整体系统的可用性，在数据的一致性方面可以进行一定的妥协，更多采用的是“最终一致性”方案，此类方案称为柔性事务。常见的柔性事务解决方案包括 TCC（补偿事务）、消息队列事务（MQ 事务）、Saga 等。</p>
<h3 id="TCC（补偿事务）"><a href="#TCC（补偿事务）" class="headerlink" title="TCC（补偿事务）"></a>TCC（补偿事务）</h3><p>TCC（Try-Confirm-Cancel）是一种补偿型事务模型，它将事务分为三个阶段：尝试阶段（Try Phase）、确认阶段（Confirm Phase）和取消阶段（Cancel Phase）。TCC 通过显式地定义事务的尝试、确认和取消逻辑，来实现分布式事务的最终一致性。</p>
<h4 id="尝试阶段（Try-Phase）"><a href="#尝试阶段（Try-Phase）" class="headerlink" title="尝试阶段（Try Phase）"></a>尝试阶段（Try Phase）</h4><p>尝试阶段的核心目标是尝试执行事务操作，并准备好业务所需的资源。</p>
<p>尝试阶段的工作流程如下：</p>
<ol>
<li><strong>业务检查</strong>：业务系统进行必要的业务检查，确保事务操作可以执行。</li>
<li><strong>资源预留</strong>：业务系统预留必要的资源，如数据库锁、缓存资源等，但并不提交事务。</li>
</ol>
<h4 id="确认阶段（Confirm-Phase）"><a href="#确认阶段（Confirm-Phase）" class="headerlink" title="确认阶段（Confirm Phase）"></a>确认阶段（Confirm Phase）</h4><p>确认阶段的核心目标是确认执行事务操作，并处理尝试阶段预留的业务资源。</p>
<p>确认阶段的工作流程如下：</p>
<ol>
<li><strong>确认执行</strong>：当所有参与者的尝试阶段都执行成功后，事务协调者（Transaction Coordinator, TC）向所有参与者发送确认指令（Confirm）。</li>
<li><strong>资源提交</strong>：参与者接收到确认指令后，提交事务并释放预留的资源。</li>
</ol>
<h4 id="取消阶段（Cancel-Phase）"><a href="#取消阶段（Cancel-Phase）" class="headerlink" title="取消阶段（Cancel Phase）"></a>取消阶段（Cancel Phase）</h4><p>取消阶段的核心目标是取消执行事务操作，并释放尝试阶段预留的资源。</p>
<p>取消阶段的工作流程如下：</p>
<ol>
<li><strong>取消执行</strong>：如果任何一个参与者的尝试阶段执行失败，或者在确认阶段出现失败，事务协调者向所有参与者发送取消指令（Cancel）。</li>
<li><strong>资源释放</strong>：参与者接收到取消指令后，回滚事务并释放预留的资源。</li>
</ol>
<h4 id="失败处理与重试机制"><a href="#失败处理与重试机制" class="headerlink" title="失败处理与重试机制"></a>失败处理与重试机制</h4><p>在 TCC 的确认阶段或取消阶段，如果出现失败，TCC 会记录事务日志并持久化到某种存储介质上，如本地磁盘文件或关系型数据库等。事务日志包含了事务的执行状态。</p>
<p>如果检测到在确认或取消阶段执行事务出现失败状态，TCC 会进行重试该阶段的事务逻辑。重试次数一般为 6 次，若超过重试次数仍然失败，则需要人工介入处理。</p>
<h4 id="事务日志的管理"><a href="#事务日志的管理" class="headerlink" title="事务日志的管理"></a>事务日志的管理</h4><p>事务日志在事务执行成功后可以被删除，以节省资源。事务日志的管理通常由事务协调者负责，确保在事务成功提交后清理相关日志。</p>
<h4 id="业务侵入性"><a href="#业务侵入性" class="headerlink" title="业务侵入性"></a>业务侵入性</h4><p>TCC 不需要依赖于底层的数据库资源，更多地是需要手动实现事务的尝试、确认和取消逻辑，因此属于业务侵入式分布式事务解决方案。开发人员需要在业务代码中显式地实现 TCC 的三个阶段，增加了开发复杂度，但同时也提供了更高的灵活性和控制力。</p>
<h3 id="MQ事务"><a href="#MQ事务" class="headerlink" title="MQ事务"></a>MQ事务</h3><p>消息队列（Message Queue, MQ）事务允许事务流应用将生产、处理、消费消息的整个过程看作是一个原子操作。常见的消息队列系统如 RocketMQ、Kafka、Pulsar、QMQ 等都提供了事务相关的功能。下面以 RocketMQ 为例，详细介绍 MQ 事务的工作原理和处理机制。</p>
<h4 id="RocketMQ-事务消息"><a href="#RocketMQ-事务消息" class="headerlink" title="RocketMQ 事务消息"></a>RocketMQ 事务消息</h4><p>RocketMQ 的事务消息机制采用了类似于两阶段提交（2PC）的流程，确保消息的生产和消费过程的原子性。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://rocketmq.apache.org/assets/images/%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF2-2673a99678f13a471b8fc0bd4ab3bf3a.png" alt="RocketMQ"></p>
<h5 id="事务消息的基本流程"><a href="#事务消息的基本流程" class="headerlink" title="事务消息的基本流程"></a>事务消息的基本流程</h5><ol>
<li><strong>发送半事务消息</strong>：<ul>
<li>生产者在消息队列中开启一个事务，然后发送“半事务”消息（Half Message）给 RocketMQ 的 Broker。此时，“半事务消息”对于消费者来说是不可见的。</li>
<li>Broker 接收到“半事务消息”后，响应“半事务消息发送成功”信息给生产者。</li>
</ul>
</li>
<li><strong>执行本地事务</strong>：<ul>
<li>生产者收到 Broker 的“发送成功”响应后，开始执行本地事务操作。</li>
<li>根据本地事务的执行状态，生产者决定向 Broker 发送“Commit”或“Rollback”指令。</li>
</ul>
</li>
<li><strong>提交或回滚事务消息</strong>：<ul>
<li>如果生产者发送“Commit”指令，Broker 将“半事务消息”转换为真正的消息，并投递给消费者进行消费。</li>
<li>如果生产者发送“Rollback”指令，Broker 将丢弃该“半事务消息”，不进行投递。</li>
</ul>
</li>
</ol>
<h5 id="失败处理与事务反查机制"><a href="#失败处理与事务反查机制" class="headerlink" title="失败处理与事务反查机制"></a>失败处理与事务反查机制</h5><p>如果在第 4 步，生产者发送“Commit”或“Rollback”消息失败了，RocketMQ 的 Broker 会定期查询生产者对应事务的本地事务执行情况，并根据反查结果决定提交或回滚这个“半事务消息”。</p>
<p>事务反查机制的实现依赖于业务代码实现的对应接口。RocketMQ 提供了事务反查的回调接口，业务系统需要实现该接口，以便 Broker 在需要时查询本地事务的状态。</p>
<h5 id="消息消费失败处理"><a href="#消息消费失败处理" class="headerlink" title="消息消费失败处理"></a>消息消费失败处理</h5><p>如果消息消费失败，RocketMQ 会进入消息重试机制，再次尝试消费消息。如果消息重试超过了最大次数，RocketMQ 会认为这个消费有问题，然后将其放入<strong>死信队列</strong>（Dead Letter Queue, DLQ）中，由人工手动排查处理。</p>
<h4 id="QMQ-事务消息"><a href="#QMQ-事务消息" class="headerlink" title="QMQ 事务消息"></a>QMQ 事务消息</h4><p>QMQ 的事务消息机制相对简单，它借助了数据库自带的事务功能，采用了类似于 eBay 提出的本地消息表方案，将分布式事务拆分成本地事务进行处理。</p>
<h5 id="本地消息表方案"><a href="#本地消息表方案" class="headerlink" title="本地消息表方案"></a>本地消息表方案</h5><ol>
<li><strong>业务操作与消息表写入</strong>：<ul>
<li>业务系统在执行本地事务操作的同时，将消息发送状态写入本地消息表。这两个操作在一个事务中提交，确保业务操作成功时消息表也写入成功。</li>
</ul>
</li>
<li><strong>消息发送</strong>：<ul>
<li>单独起一个线程定时轮询消息表，将未处理的消息发送到消息中间件（如 RocketMQ、Kafka 等）。</li>
<li>消息发送成功后，更新消息状态为成功或直接删除消息。</li>
</ul>
</li>
</ol>
<h5 id="优点与适用场景"><a href="#优点与适用场景" class="headerlink" title="优点与适用场景"></a>优点与适用场景</h5><p>QMQ 的事务消息方案中，即使消息队列挂掉，也不会影响数据库事务的执行，因此更加适应于大多数业务场景。这种方法同样适用于其他消息队列，只是 QMQ 封装得更好，提供了开箱即用的解决方案。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/user.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/user.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">xiaoyan</div><div class="post-copyright__author_desc">无限进步。</div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/2024/10/27/%E5%88%86%E5%B8%83%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/2024/10/27/%E5%88%86%E5%B8%83%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/')">分布式-分布式事务</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/2024/10/27/%E5%88%86%E5%B8%83%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=分布式-分布式事务&amp;url=http://example.com/2024/10/27/%E5%88%86%E5%B8%83%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/&amp;pic=https://xiaoyanfufu-io.oss-cn-guangzhou.aliyuncs.com/blog/202410281041645.png" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">XIAOYAN</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__category-list"><a class="post-meta__box__categoryes" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"><span class="categoryes-punctuation"> <i class="anzhiyufont anzhiyu-icon-inbox"></i></span>分布式<span class="categoryesPageCount">4</span></a></div><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>分布式事务<span class="tagsPageCount">1</span></a></div></div><div class="post_share"><div class="social-share" data-image="https://pic1.zhimg.com/v2-b76d79b11c3e8dd25f3c6abae8889a88_720w.jpg?source=172ae18b" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/10/21/%E5%88%86%E5%B8%83%E5%BC%8F-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%EF%BC%88%E4%B8%8B%EF%BC%89/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://xiaoyanfufu-io.oss-cn-guangzhou.aliyuncs.com/blog/202410272103963.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">分布式-服务治理（下）</div></div></a></div><div class="next-post pull-right"><a href="/2024/10/28/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://xiaoyanfufu-io.oss-cn-guangzhou.aliyuncs.com/blog/202410282316960.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">操作系统-进程管理</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/images/user.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__description">是一只时时翻垃圾吃的宅子。</div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">xiaoyan</h1><div class="author-info__desc">无限进步。</div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/xiaoyanfufu" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/483597064" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="card-widget anzhiyu-right-widget" id="card-wechat" onclick="null"><div id="flip-wrapper"><div id="flip-content"><div class="face" style="background: url(https://bu.dusays.com/2023/01/13/63c02edf44033.png) center center / 100% no-repeat"></div><div class="back face" style="background: url(https://bu.dusays.com/2023/05/13/645fa415e8694.png) center center / 100% no-repeat"></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E4%BA%8B%E5%8A%A1%EF%BC%9F"><span class="toc-number">1.1.</span> <span class="toc-text">为什么需要事务？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.2.</span> <span class="toc-text">数据库事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.1.</span> <span class="toc-text">数据库事务实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">1.2.2.</span> <span class="toc-text">事务隔离级别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.3.</span> <span class="toc-text">分布式事务</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">2.</span> <span class="toc-text">分布式事务解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9A%E6%80%A7%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.1.</span> <span class="toc-text">刚性事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2PC%EF%BC%88%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E5%8D%8F%E8%AE%AE%EF%BC%89"><span class="toc-number">2.1.1.</span> <span class="toc-text">2PC（二阶段提交协议）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5%EF%BC%88Prepare%EF%BC%89"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">准备阶段（Prepare）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E9%98%B6%E6%AE%B5%EF%BC%88Commit-Phase%EF%BC%89"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">提交阶段（Commit Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">2.1.1.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3PC%EF%BC%88%E4%B8%89%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E5%8D%8F%E8%AE%AE%EF%BC%89"><span class="toc-number">2.1.2.</span> <span class="toc-text">3PC（三阶段提交协议）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5%EF%BC%88CanCommit-Phase%EF%BC%89"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">准备阶段（CanCommit Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E6%8F%90%E4%BA%A4%E9%98%B6%E6%AE%B5%EF%BC%88PreCommit-Phase%EF%BC%89"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">预提交阶段（PreCommit Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E4%BA%8B%E5%8A%A1%E6%8F%90%E4%BA%A4%E9%98%B6%E6%AE%B5%EF%BC%88DoCommit-Phase%EF%BC%89"><span class="toc-number">2.1.2.3.</span> <span class="toc-text">执行事务提交阶段（DoCommit Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-number">2.1.2.4.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.2.</span> <span class="toc-text">柔性事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TCC%EF%BC%88%E8%A1%A5%E5%81%BF%E4%BA%8B%E5%8A%A1%EF%BC%89"><span class="toc-number">2.2.1.</span> <span class="toc-text">TCC（补偿事务）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E9%98%B6%E6%AE%B5%EF%BC%88Try-Phase%EF%BC%89"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">尝试阶段（Try Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E8%AE%A4%E9%98%B6%E6%AE%B5%EF%BC%88Confirm-Phase%EF%BC%89"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">确认阶段（Confirm Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%96%E6%B6%88%E9%98%B6%E6%AE%B5%EF%BC%88Cancel-Phase%EF%BC%89"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">取消阶段（Cancel Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86%E4%B8%8E%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="toc-number">2.2.1.4.</span> <span class="toc-text">失败处理与重试机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%97%A5%E5%BF%97%E7%9A%84%E7%AE%A1%E7%90%86"><span class="toc-number">2.2.1.5.</span> <span class="toc-text">事务日志的管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E4%BE%B5%E5%85%A5%E6%80%A7"><span class="toc-number">2.2.1.6.</span> <span class="toc-text">业务侵入性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MQ%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.2.2.</span> <span class="toc-text">MQ事务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RocketMQ-%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">RocketMQ 事务消息</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.2.1.1.</span> <span class="toc-text">事务消息的基本流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86%E4%B8%8E%E4%BA%8B%E5%8A%A1%E5%8F%8D%E6%9F%A5%E6%9C%BA%E5%88%B6"><span class="toc-number">2.2.2.1.2.</span> <span class="toc-text">失败处理与事务反查机制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86"><span class="toc-number">2.2.2.1.3.</span> <span class="toc-text">消息消费失败处理</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#QMQ-%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">QMQ 事务消息</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%B6%88%E6%81%AF%E8%A1%A8%E6%96%B9%E6%A1%88"><span class="toc-number">2.2.2.2.1.</span> <span class="toc-text">本地消息表方案</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%98%E7%82%B9%E4%B8%8E%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.2.2.2.2.</span> <span class="toc-text">优点与适用场景</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>最近发布</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/11/03/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" title="数据库优化-分库分表"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://pic1.zhimg.com/v2-b76d79b11c3e8dd25f3c6abae8889a88_720w.jpg?source=172ae18b" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据库优化-分库分表"/></a><div class="content"><a class="title" href="/2024/11/03/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8/" title="数据库优化-分库分表">数据库优化-分库分表</a><time datetime="2024-11-03T08:20:54.000Z" title="发表于 2024-11-03 16:20:54">2024-11-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/03/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E4%B8%8E%E5%86%B7%E7%83%AD%E5%88%86%E7%A6%BB/" title="数据库优化-读写分离与冷热分离"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://xiaoyanfufu-io.oss-cn-guangzhou.aliyuncs.com/blog/202411041125092.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据库优化-读写分离与冷热分离"/></a><div class="content"><a class="title" href="/2024/11/03/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E4%B8%8E%E5%86%B7%E7%83%AD%E5%88%86%E7%A6%BB/" title="数据库优化-读写分离与冷热分离">数据库优化-读写分离与冷热分离</a><time datetime="2024-11-03T08:18:25.000Z" title="发表于 2024-11-03 16:18:25">2024-11-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/28/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/" title="操作系统-进程管理"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://xiaoyanfufu-io.oss-cn-guangzhou.aliyuncs.com/blog/202410282316960.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="操作系统-进程管理"/></a><div class="content"><a class="title" href="/2024/10/28/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/" title="操作系统-进程管理">操作系统-进程管理</a><time datetime="2024-10-28T14:52:35.000Z" title="发表于 2024-10-28 22:52:35">2024-10-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/27/%E5%88%86%E5%B8%83%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" title="分布式-分布式事务"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://xiaoyanfufu-io.oss-cn-guangzhou.aliyuncs.com/blog/202410281041645.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="分布式-分布式事务"/></a><div class="content"><a class="title" href="/2024/10/27/%E5%88%86%E5%B8%83%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" title="分布式-分布式事务">分布式-分布式事务</a><time datetime="2024-10-27T13:08:20.000Z" title="发表于 2024-10-27 21:08:20">2024-10-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/21/%E5%88%86%E5%B8%83%E5%BC%8F-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%EF%BC%88%E4%B8%8B%EF%BC%89/" title="分布式-服务治理（下）"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://xiaoyanfufu-io.oss-cn-guangzhou.aliyuncs.com/blog/202410272103963.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="分布式-服务治理（下）"/></a><div class="content"><a class="title" href="/2024/10/21/%E5%88%86%E5%B8%83%E5%BC%8F-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%EF%BC%88%E4%B8%8B%EF%BC%89/" title="分布式-服务治理（下）">分布式-服务治理（下）</a><time datetime="2024-10-21T07:24:49.000Z" title="发表于 2024-10-21 15:24:49">2024-10-21</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2024 By <a class="footer-bar-link" href="/" title="xiaoyan" target="_blank">xiaoyan</a></div></div><div id="footer-type-tips"></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">44</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">65</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">17</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://blog.anheyu.com/" title="博客"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div><div class="back-menu-list-group"><div class="back-menu-list-title">项目</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://image.anheyu.com/" title="安知鱼图床"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://image.anheyu.com/favicon.ico" alt="安知鱼图床"/><span class="back-menu-item-text">安知鱼图床</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=12613265870&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AOP/" style="font-size: 0.88rem;">AOP<sup>1</sup></a><a href="/tags/Bean/" style="font-size: 0.88rem;">Bean<sup>1</sup></a><a href="/tags/DDD/" style="font-size: 0.88rem;">DDD<sup>1</sup></a><a href="/tags/IoC/" style="font-size: 0.88rem;">IoC<sup>1</sup></a><a href="/tags/Java8%E6%96%B0%E7%89%B9%E6%80%A7/" style="font-size: 0.88rem;">Java8新特性<sup>1</sup></a><a href="/tags/Java%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" style="font-size: 0.88rem;">Java基本概念<sup>1</sup></a><a href="/tags/List/" style="font-size: 0.88rem;">List<sup>1</sup></a><a href="/tags/Map/" style="font-size: 0.88rem;">Map<sup>2</sup></a><a href="/tags/MyBatis/" style="font-size: 0.88rem;">MyBatis<sup>1</sup></a><a href="/tags/MySQL%E5%9F%BA%E7%A1%80/" style="font-size: 0.88rem;">MySQL基础<sup>1</sup></a><a href="/tags/Object/" style="font-size: 0.88rem;">Object<sup>1</sup></a><a href="/tags/SQL%E8%B0%83%E4%BC%98/" style="font-size: 0.88rem;">SQL调优<sup>1</sup></a><a href="/tags/Set/" style="font-size: 0.88rem;">Set<sup>1</sup></a><a href="/tags/SpringBoot/" style="font-size: 0.88rem;">SpringBoot<sup>1</sup></a><a href="/tags/SpringCloud/" style="font-size: 0.88rem;">SpringCloud<sup>1</sup></a><a href="/tags/%E4%BA%8B%E5%8A%A1/" style="font-size: 0.88rem;">事务<sup>2</sup></a><a href="/tags/%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B/" style="font-size: 0.88rem;">内存模型<sup>1</sup></a><a href="/tags/%E5%8F%8D%E5%B0%84/" style="font-size: 0.88rem;">反射<sup>1</sup></a><a href="/tags/%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6/" style="font-size: 0.88rem;">垃圾回收<sup>1</sup></a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 0.88rem;">多线程<sup>1</sup></a><a href="/tags/%E5%AF%B9%E8%B1%A1/" style="font-size: 0.88rem;">对象<sup>1</sup></a><a href="/tags/%E5%B9%B6%E5%8F%91%E5%AE%89%E5%85%A8/" style="font-size: 0.88rem;">并发安全<sup>1</sup></a><a href="/tags/%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 0.88rem;">序列化<sup>1</sup></a><a href="/tags/%E5%BC%82%E5%B8%B8/" style="font-size: 0.88rem;">异常<sup>1</sup></a><a href="/tags/%E6%8B%B7%E8%B4%9D/" style="font-size: 0.88rem;">拷贝<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" style="font-size: 0.88rem;">数据类型<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 0.88rem;">数据结构<sup>1</sup></a><a href="/tags/%E6%97%A5%E5%BF%97/" style="font-size: 0.88rem;">日志<sup>2</sup></a><a href="/tags/%E6%9F%A5%E8%AF%A2/" style="font-size: 0.88rem;">查询<sup>1</sup></a><a href="/tags/%E6%B3%9B%E5%9E%8B/" style="font-size: 0.88rem;">泛型<sup>1</sup></a><a href="/tags/%E6%B3%A8%E8%A7%A3/" style="font-size: 0.88rem;">注解<sup>1</sup></a><a href="/tags/%E7%AD%96%E7%95%A5/" style="font-size: 0.88rem;">策略<sup>1</sup></a><a href="/tags/%E7%B1%BB%E5%88%9D%E5%A7%8B%E5%8C%96/" style="font-size: 0.88rem;">类初始化<sup>1</sup></a><a href="/tags/%E7%B1%BB%E5%8A%A0%E8%BD%BD/" style="font-size: 0.88rem;">类加载<sup>1</sup></a><a href="/tags/%E7%B4%A2%E5%BC%95/" style="font-size: 0.88rem;">索引<sup>2</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B/" style="font-size: 0.88rem;">线程模型<sup>1</sup></a><a href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" style="font-size: 0.88rem;">线程池<sup>1</sup></a><a href="/tags/%E9%94%81/" style="font-size: 0.88rem;">锁<sup>2</sup></a><a href="/tags/%E9%9B%86%E7%BE%A4/" style="font-size: 0.88rem;">集群<sup>1</sup></a><a href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" style="font-size: 0.88rem;">面向对象<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script async src="/anzhiyu/random.js"></script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>