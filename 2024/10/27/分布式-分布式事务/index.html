<!DOCTYPE html>
<html lang="en">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  
    <link rel="icon" href="/images/earthstars.png">
  
  
  <title>分布式-分布式事务 | XIAOYAN</title>
  <link rel="canonical" href="http://example.com/2024/10/27/%E5%88%86%E5%B8%83%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/">
  <meta name="author" content="xiaoyan" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="分布式事务" />
  
  <meta name="description" content="事务为什么需要事务？在复杂的系统操作中，数据一致性是一个关键问题。例如，在转账场景中，A向B转账100元，执行顺序为先扣除A账户中的100元，再向B账户中增加100元。如果系统在扣除A账户的100元后突然宕机，B账户并未增加100元，这将导致数据不一致。为了解决这类问题，事务机制应运而生。事务确保一组操作要么全部完成，要么全部不完成，从而保证数据的一致性和完整性。 数据库事务在日常开发中，特别是在">
<meta property="og:type" content="article">
<meta property="og:title" content="分布式-分布式事务">
<meta property="og:url" content="http://example.com/2024/10/27/%E5%88%86%E5%B8%83%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/index.html">
<meta property="og:site_name" content="XIAOYAN">
<meta property="og:description" content="事务为什么需要事务？在复杂的系统操作中，数据一致性是一个关键问题。例如，在转账场景中，A向B转账100元，执行顺序为先扣除A账户中的100元，再向B账户中增加100元。如果系统在扣除A账户的100元后突然宕机，B账户并未增加100元，这将导致数据不一致。为了解决这类问题，事务机制应运而生。事务确保一组操作要么全部完成，要么全部不完成，从而保证数据的一致性和完整性。 数据库事务在日常开发中，特别是在">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://xiaoyanfufu-io.oss-cn-guangzhou.aliyuncs.com/blog/202410281041645.png">
<meta property="og:image" content="https://xiaoyanfufu-io.oss-cn-guangzhou.aliyuncs.com/blog/202410281126640.png">
<meta property="og:image" content="https://rocketmq.apache.org/assets/images/%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF2-2673a99678f13a471b8fc0bd4ab3bf3a.png">
<meta property="article:published_time" content="2024-10-27T13:08:20.000Z">
<meta property="article:modified_time" content="2024-10-28T08:01:58.407Z">
<meta property="article:author" content="xiaoyan">
<meta property="article:tag" content="分布式事务">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xiaoyanfufu-io.oss-cn-guangzhou.aliyuncs.com/blog/202410281041645.png">
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kr-core.min.css" media="all"></link>
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/highlight.js/night-eighties.min.css" media="all"></link>
  
  <link rel="stylesheet" id="theme-light-css" href="/css/kr-theme/light.min.css" media="all"></link>
  <link rel="stylesheet" id="theme-dark-css" href="/css/kr-theme/dark.min.css" media="(prefers-color-scheme: dark)"></link>
  <script src="/js/kr-theme.min.js"></script>
  <link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"></link>
  
    <link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"></link>
  
  
    <link rel="stylesheet" href="/vendors/viewerjs@1.11.6/dist/viewer.min.css"></link>
  
  <!-- 不得不预先加载的一些JS文件 -->
  
    <script src="/vendors/qr-code-styling@1.6.0-rc.1/lib/qr-code-styling.js"></script>
  
  <!-- 自定义站点横幅和背景 -->
  <style>
    
      .kratos-cover.kratos-cover-2 {
        background-image: url('/images/wallpaper_light.png');
      }
      html[data-theme="dark"] .kratos-cover.kratos-cover-2 {
        background-image: url('/images/wallpaper_dark.png');
      }
    
    
      @media(min-width:768px) {
        body.custom-background {
          background-image: url('/images/bg.webp');
        }
        html[data-theme="dark"] body.custom-background {
          background-image: url('/images/bg.webp');
        }
      }
    
    
      .widget-kratos-about .photo-background {
        background-image: url('/images/default.webp');
      }
      html[data-theme="dark"] .widget-kratos-about .photo-background {
        background-image: url('/images/default.webp');
      }
    
  </style>

  <!-- 额外的追加注入项 -->
  
    <link rel="stylesheet" href="/css/custom.css">

  
<meta name="generator" content="Hexo 7.3.0"></head>

    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    <li>
                                        
                                            <a href="/">
                                        
                                            
                                                <i class="fa fa-home"></i>
                                            
                                            首页
                                        </a>
                                        
                                    </li>
                                
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">XIAOYAN</a></div>
                    <div id="kratos-nav-toggle-wrapper" class="nav-toggle">
                        <a id="kratos-nav-toggle" class="kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>XIAOYAN</h2> <br />
                        <span>山重水复疑无路，柳暗花明又一村。</span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">


        

            

            <section class="kr-main-col col-md-8">

        

            <article itemscope itemtype="https://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/27/%E5%88%86%E5%B8%83%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/">
    <div class="kratos-hentry kratos-page-inner clearfix">
        <header class="kratos-page-header">
            
                <h1 class="kratos-page-title text-center" itemprop="name headline">分布式-分布式事务</h1>
            
            <ul class="kratos-page-meta text-center">
                <li><time datetime="2024-10-27T13:08:20.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2024-10-27</time></li>
                <li itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <i class="fa fa-user"></i> 作者 <span itemprop="name">xiaoyan</span>
                </li>
                
                    <li>
                        <i class="fa fa-edit"></i> 
                        
                        
                            ~7.56K
                        
                        字
                    </li>
                
                
                
            </ul>
        </header>
        <div class="kratos-page-content kr-post">
            
            
            
                <div class="kratos-post-inner-toc toc-div-class" >
                    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E4%BA%8B%E5%8A%A1%EF%BC%9F"><span class="toc-number">1.1.</span> <span class="toc-text">为什么需要事务？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.2.</span> <span class="toc-text">数据库事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.1.</span> <span class="toc-text">数据库事务实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">1.2.2.</span> <span class="toc-text">事务隔离级别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.3.</span> <span class="toc-text">分布式事务</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">2.</span> <span class="toc-text">分布式事务解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9A%E6%80%A7%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.1.</span> <span class="toc-text">刚性事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2PC%EF%BC%88%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E5%8D%8F%E8%AE%AE%EF%BC%89"><span class="toc-number">2.1.1.</span> <span class="toc-text">2PC（二阶段提交协议）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5%EF%BC%88Prepare%EF%BC%89"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">准备阶段（Prepare）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E9%98%B6%E6%AE%B5%EF%BC%88Commit-Phase%EF%BC%89"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">提交阶段（Commit Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">2.1.1.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3PC%EF%BC%88%E4%B8%89%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E5%8D%8F%E8%AE%AE%EF%BC%89"><span class="toc-number">2.1.2.</span> <span class="toc-text">3PC（三阶段提交协议）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5%EF%BC%88CanCommit-Phase%EF%BC%89"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">准备阶段（CanCommit Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E6%8F%90%E4%BA%A4%E9%98%B6%E6%AE%B5%EF%BC%88PreCommit-Phase%EF%BC%89"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">预提交阶段（PreCommit Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E4%BA%8B%E5%8A%A1%E6%8F%90%E4%BA%A4%E9%98%B6%E6%AE%B5%EF%BC%88DoCommit-Phase%EF%BC%89"><span class="toc-number">2.1.2.3.</span> <span class="toc-text">执行事务提交阶段（DoCommit Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-number">2.1.2.4.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.2.</span> <span class="toc-text">柔性事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TCC%EF%BC%88%E8%A1%A5%E5%81%BF%E4%BA%8B%E5%8A%A1%EF%BC%89"><span class="toc-number">2.2.1.</span> <span class="toc-text">TCC（补偿事务）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E9%98%B6%E6%AE%B5%EF%BC%88Try-Phase%EF%BC%89"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">尝试阶段（Try Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E8%AE%A4%E9%98%B6%E6%AE%B5%EF%BC%88Confirm-Phase%EF%BC%89"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">确认阶段（Confirm Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%96%E6%B6%88%E9%98%B6%E6%AE%B5%EF%BC%88Cancel-Phase%EF%BC%89"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">取消阶段（Cancel Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86%E4%B8%8E%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="toc-number">2.2.1.4.</span> <span class="toc-text">失败处理与重试机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%97%A5%E5%BF%97%E7%9A%84%E7%AE%A1%E7%90%86"><span class="toc-number">2.2.1.5.</span> <span class="toc-text">事务日志的管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E4%BE%B5%E5%85%A5%E6%80%A7"><span class="toc-number">2.2.1.6.</span> <span class="toc-text">业务侵入性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MQ%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.2.2.</span> <span class="toc-text">MQ事务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RocketMQ-%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">RocketMQ 事务消息</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.2.1.1.</span> <span class="toc-text">事务消息的基本流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86%E4%B8%8E%E4%BA%8B%E5%8A%A1%E5%8F%8D%E6%9F%A5%E6%9C%BA%E5%88%B6"><span class="toc-number">2.2.2.1.2.</span> <span class="toc-text">失败处理与事务反查机制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86"><span class="toc-number">2.2.2.1.3.</span> <span class="toc-text">消息消费失败处理</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#QMQ-%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">QMQ 事务消息</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%B6%88%E6%81%AF%E8%A1%A8%E6%96%B9%E6%A1%88"><span class="toc-number">2.2.2.2.1.</span> <span class="toc-text">本地消息表方案</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%98%E7%82%B9%E4%B8%8E%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.2.2.2.2.</span> <span class="toc-text">优点与适用场景</span></a></li></ol></li></ol></li></ol></li></ol></li></ol>
                </div>
            
            <hr />
            <div itemprop="articleBody"><h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><h2 id="为什么需要事务？"><a href="#为什么需要事务？" class="headerlink" title="为什么需要事务？"></a>为什么需要事务？</h2><p>在复杂的系统操作中，数据一致性是一个关键问题。例如，在转账场景中，A向B转账100元，执行顺序为先扣除A账户中的100元，再向B账户中增加100元。如果系统在扣除A账户的100元后突然宕机，B账户并未增加100元，这将导致数据不一致。为了解决这类问题，事务机制应运而生。事务确保一组操作要么全部完成，要么全部不完成，从而保证数据的一致性和完整性。</p>
<h2 id="数据库事务"><a href="#数据库事务" class="headerlink" title="数据库事务"></a>数据库事务</h2><p>在日常开发中，特别是在单体架构中，<strong>数据库事务</strong>是最常见的事务类型。数据库事务可以保证多个数据库操作作为一个逻辑上的整体来执行，遵循“要么全部完成，要么全部不完成”的原则。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 开启事务</span><br><span class="line"><span class="keyword">START</span> TRANSACTION;</span><br><span class="line"># 多条<span class="keyword">SQL</span>语句</span><br><span class="line">...</span><br><span class="line"># 提交事务</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure>

<p>数据库事务具有ACID特性，确保数据的可靠性和一致性：</p>
<ul>
<li><strong>原子性（Atomicity）</strong>：事务是最小的执行单位，不可分割。事务的原子性确保动作要么全部完成，要么全部失败。</li>
<li><strong>一致性（Consistency）</strong>：执行事务前后，数据要保持一致。例如，在转账事务中，无论转账成功与否，转账者和收款者的总额应保持不变。</li>
<li><strong>隔离性（Isolation）</strong>：并发数据库访问时，一个事务不会影响另外一个事务，事务之间是独立的。</li>
<li><strong>持久性（Durability）</strong>：一个事务被提交之后，在数据库中的修改是永久的，即使数据库发生故障也不会对其有任何影响。</li>
</ul>
<p>需要注意的是，A、I、D是实现手段，而C是最终目的。</p>
<h3 id="数据库事务实现原理"><a href="#数据库事务实现原理" class="headerlink" title="数据库事务实现原理"></a>数据库事务实现原理</h3><p>MySQL默认的InnoDB引擎通过以下机制实现事务的ACID特性：</p>
<ul>
<li><strong>原子性（Atomicity）</strong>：通过undo log（回滚日志）来保证。undo log记录了事务执行前的数据状态，如果事务执行过程中发生错误，可以通过undo log回滚到事务开始前的状态。</li>
<li><strong>持久性（Durability）</strong>：通过redo log（重做日志）来保证。redo log记录了事务执行后的数据状态，即使数据库发生故障，也可以通过redo log恢复到事务提交后的状态。</li>
<li><strong>隔离性（Isolation）</strong>：通过锁机制和MVCC（多版本并发控制）来保证。锁机制确保事务在执行过程中不会被其他事务干扰，MVCC通过为每个事务创建一个版本号，确保事务之间的数据隔离。</li>
<li><strong>一致性（Consistency）</strong>：通过上述机制的协同作用，确保事务执行前后数据的一致性。</li>
</ul>
<h3 id="事务隔离级别"><a href="#事务隔离级别" class="headerlink" title="事务隔离级别"></a>事务隔离级别</h3><p>MySQL默认的事务隔离级别是Repeatable-read（可重复读），不同的隔离级别会影响事务的并发性能和数据一致性：</p>
<ul>
<li><strong>Read Uncommitted（读未提交）</strong>：最低的隔离级别，事务可以读取到其他事务未提交的数据，可能导致脏读、不可重复读和幻读。</li>
<li><strong>Read Committed（读已提交）</strong>：事务只能读取到其他事务已提交的数据，避免了脏读，但可能出现不可重复读和幻读。</li>
<li><strong>Repeatable Read（可重复读）</strong>：事务在执行过程中多次读取同一数据时，结果保持一致，避免了不可重复读，但可能出现幻读。</li>
<li><strong>Serializable（串行化）</strong>：最高的隔离级别，事务串行执行，避免了所有并发问题，但性能最低。</li>
</ul>
<p>通过理解事务的ACID特性和实现原理，开发人员可以更好地设计和实现可靠的数据库操作，确保系统的数据一致性和稳定性。</p>
<h2 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h2><p>在微服务架构下，一个系统被拆分为多个小的微服务，每个微服务可能存在不同的服务器上，并且每个微服务可能都有一个单独的数据库供自己使用。这种情况下，一组操作可能涉及多个微服务以及多个数据库。</p>
<p>例如，在电商系统中，创建一个订单一般会涉及到两个表以上的操作：订单表加1，库存表减1。而订单表和库存表可能分别存放在不同服务器的数据库中。这种场景下想要保证数据的一致性，应该如何实现？</p>
<p>此时，想通过数据库自带的事务管理可能不太够用了，需要通过<strong>分布式事务</strong>来实现。</p>
<p>涉及在不同的数据库进行操作时，都应该引入分布式事务。比如在单个数据库的性能达到瓶颈或数据量过大时，我们需要进行分库，分库之后，同一个数据库的表数据分布在了不同的表中。</p>
<p>分布式事务的最终目的，也就是保证多个相关联的数据库之间的数据保持一致。按道理来说既然是保证一致性，那么应该也是保证ACID特性。但由于性能、可用性等方面考虑，分布式事务往往无法保证ACID，而只能选择一个比较折中的方案。</p>
<h1 id="分布式事务解决方案"><a href="#分布式事务解决方案" class="headerlink" title="分布式事务解决方案"></a>分布式事务解决方案</h1><h2 id="刚性事务"><a href="#刚性事务" class="headerlink" title="刚性事务"></a>刚性事务</h2><p>在互联网分布式场景中，某些关键业务场景要求数据具备强一致性，因此需要采用能够保证这种特性的解决方案，这类解决方案被称为刚性事务。常见的刚性事务解决方案包括两阶段提交（2PC）、三阶段提交（3PC）等。</p>
<p>2PC 和 3PC 属于业务代码无侵入式的解决方案，它们都是基于 XA 规范衍生出来的实现。</p>
<p>XA 规范是由 X&#x2F;Open 组织提出的分布式事务处理标准，定义了分布式事务管理器（Transaction Manager, TM）和资源管理器（Resource Manager, RM）之间的接口：</p>
<ul>
<li>AP（Application Program）：应用程序本身。</li>
<li>RM（Resource Manager）：资源管理器，是事务的参与者，绝大多数情况下指代的都是数据库，一个分布式事务通常涉及多个RM。</li>
<li>TM（Transaction Manager）：事务管理器&#x2F;协调者，负责管理全局事务，分配事务唯一标识符，监控事务的执行进度，并负责事务的提交、回滚、失败恢复等。</li>
</ul>
<h3 id="2PC（二阶段提交协议）"><a href="#2PC（二阶段提交协议）" class="headerlink" title="2PC（二阶段提交协议）"></a>2PC（二阶段提交协议）</h3><p><img src="https://xiaoyanfufu-io.oss-cn-guangzhou.aliyuncs.com/blog/202410281041645.png" alt="2PC"></p>
<p>2PC（Two-Phase Commit），即两阶段提交协议，是一种经典的分布式事务协议，旨在确保分布式系统中的多个节点在事务提交或回滚时保持一致性。2PC 分为两个阶段：准备阶段（Prepare Phase）和提交阶段（Commit Phase）。</p>
<h4 id="准备阶段（Prepare）"><a href="#准备阶段（Prepare）" class="headerlink" title="准备阶段（Prepare）"></a>准备阶段（Prepare）</h4><p>准备阶段的核心目标是确认所有事务参与者是否能够成功执行本地数据库操作。</p>
<p>准备阶段的工作流程如下：</p>
<ol>
<li><strong>询问阶段</strong>：事务管理者&#x2F;协调者（Transaction Manager, TM）向所有涉及到事务的参与者（Resource Manager, RM）发送询问消息，询问它们是否可以执行事务操作，并等待 RM 的回复。</li>
<li><strong>执行阶段</strong>：RM 接收到询问消息后，执行本地事务操作，如写入 redo log、undo log 等。此时，事务尚未提交。如果 RM 能够成功执行事务操作，则向 TM 响应“Yes”表示已就绪；如果事务执行失败，则响应“No”表示未就绪。</li>
</ol>
<h4 id="提交阶段（Commit-Phase）"><a href="#提交阶段（Commit-Phase）" class="headerlink" title="提交阶段（Commit Phase）"></a>提交阶段（Commit Phase）</h4><p>提交阶段的核心目标是确认所有事务参与者是否能够成功提交本地事务。</p>
<p>当准备阶段的所有参与者都响应“已就绪”状态给 TM 时，进入事务提交阶段：</p>
<ol>
<li><strong>提交指令</strong>：TM 向所有 RM 发送“Commit”指令，表示 RM 可以进行事务提交。</li>
<li><strong>提交事务</strong>：RM 接收到“Commit”指令后，开始提交本地事务，并释放占用的数据库资源。</li>
<li><strong>确认提交</strong>：RM 提交事务后，向 TM 回复“ACK”确认消息，表示事务已完成提交。</li>
<li><strong>事务结束</strong>：TM 收到所有 RM 的确认消息后，整个分布式事务正式结束。</li>
</ol>
<p>然而，如果在提交阶段有部分参与者响应“未就绪”状态，则表示有部分事务执行失败。根据事务的原子性原则，此时需要进行事务回滚：</p>
<ol>
<li><strong>回滚指令</strong>：TM 向所有 RM 发送“Rollback”指令，表示 RM 需要进行事务回滚。</li>
<li><strong>回滚事务</strong>：RM 接收到“Rollback”指令后，开始回滚本地事务，并释放占用的数据库资源。</li>
<li><strong>确认回滚</strong>：RM 回滚事务后，向 TM 回复“ACK”确认消息，表示事务回滚已完成。</li>
<li><strong>事务中断</strong>：TM 收到所有 RM 的确认消息后，中断整个事务。</li>
</ol>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>2PC 的准备阶段旨在确认所有参与者是否能够执行事务操作；提交阶段则确认参与者的事务提交状态。提交阶段的结果由准备阶段决定，是进行提交还是进行回滚。</p>
<p>2PC 的优点：</p>
<ul>
<li><strong>简单易实现</strong>：2PC 的实现相对简单，易于理解和部署。</li>
<li><strong>强一致性</strong>：2PC 能够确保事务的强一致性，适用于对数据一致性要求极高的场景。</li>
</ul>
<p>2PC 的缺点：</p>
<ul>
<li><strong>同步阻塞</strong>：由于需要保持强一致性，2PC 在事务期间会占用资源，导致其他事务被阻塞，降低了系统的可用性。</li>
<li><strong>数据不一致</strong>：如果 TM 在事务过程中突然宕机，可能会导致部分参与者已经提交事务，而其他参与者尚未提交，从而引发数据不一致问题。</li>
<li><strong>单点故障</strong>：TM 在 2PC 中扮演着至关重要的角色，如果 TM 宕机，其他 RM 将无法继续进行事务操作，导致系统停滞。</li>
</ul>
<h3 id="3PC（三阶段提交协议）"><a href="#3PC（三阶段提交协议）" class="headerlink" title="3PC（三阶段提交协议）"></a>3PC（三阶段提交协议）</h3><img src="https://xiaoyanfufu-io.oss-cn-guangzhou.aliyuncs.com/blog/202410281126640.png" alt="3PC" style="zoom:67%;">

<p>3PC（Three-Phase Commit）是对 2PC 的改进，通过引入一个预提交阶段（PreCommit Phase）来减少阻塞问题，并提高系统的可用性。3PC 将事务的准备阶段分为两个部分：准备阶段（CanCommit Phase）和预提交阶段（PreCommit Phase），再加上最终的提交阶段（DoCommit Phase）。</p>
<h4 id="准备阶段（CanCommit-Phase）"><a href="#准备阶段（CanCommit-Phase）" class="headerlink" title="准备阶段（CanCommit Phase）"></a>准备阶段（CanCommit Phase）</h4><p>准备阶段（CanCommit Phase）的核心目的是确认所有参与者（Resource Manager, RM）的响应能力和是否能够执行本地数据库事务操作。</p>
<p>准备阶段的工作流程如下：</p>
<ol>
<li><strong>询问阶段</strong>：事务管理者&#x2F;协调者（Transaction Manager, TM）向所有 RM 发送“CanCommit”询问消息，询问它们是否能够执行事务操作，并等待 RM 的回复。</li>
<li><strong>响应阶段</strong>：RM 接收到“CanCommit”询问消息后，不会执行实际的事务操作，而是根据自身状态判断是否能够执行事务。如果 RM 能够执行事务操作，则向 TM 响应“Yes”表示可以执行；如果 RM 不能执行事务操作，则响应“No”表示不能执行；如果 RM 超时未响应，TM 也会认为 RM 不能执行事务。</li>
</ol>
<h4 id="预提交阶段（PreCommit-Phase）"><a href="#预提交阶段（PreCommit-Phase）" class="headerlink" title="预提交阶段（PreCommit Phase）"></a>预提交阶段（PreCommit Phase）</h4><p>如果准备阶段中所有的 RM 都回复了“Yes”，则进入预提交阶段（PreCommit Phase）。预提交阶段的核心目的是让 RM 执行本地事务操作，但并不提交事务。</p>
<p>预提交阶段的工作流程如下：</p>
<ol>
<li><strong>预提交指令</strong>：TM 向所有 RM 发送“PreCommit”指令，表示 RM 可以执行本地事务操作，但不要提交。</li>
<li><strong>执行事务操作</strong>：RM 接收到“PreCommit”指令后，执行本地事务操作，但并不提交事务。如果 RM 成功执行事务操作，则向 TM 响应“Yes”表示事务执行完毕；如果 RM 执行事务操作失败，则响应“No”表示事务执行失败。</li>
<li><strong>超时机制</strong>：在预提交阶段，TM 和 RM 都引入了超时机制。如果 TM 在一定时间内未收到 RM 的响应，或者 RM 在执行事务操作时超时，都会触发事务回滚，以解除资源占用，避免事务阻塞。</li>
</ol>
<h4 id="执行事务提交阶段（DoCommit-Phase）"><a href="#执行事务提交阶段（DoCommit-Phase）" class="headerlink" title="执行事务提交阶段（DoCommit Phase）"></a>执行事务提交阶段（DoCommit Phase）</h4><p>进行真正的事务提交。</p>
<p>如果 TM 在预提交阶段收到了所有 RM 响应“Yes”，则进入最终的提交阶段（DoCommit Phase）。</p>
<p>提交阶段的工作流程如下：</p>
<ol>
<li><strong>提交指令</strong>：TM 向所有 RM 发送“DoCommit”指令，表示 RM 可以进行事务提交。</li>
<li><strong>提交事务</strong>：RM 接收到“DoCommit”指令后，提交本地数据库事务，并释放占用的资源。</li>
<li><strong>确认提交</strong>：RM 提交事务后，向 TM 回复“Committed”确认消息，表示事务已完成提交。</li>
<li><strong>事务结束</strong>：TM 收到所有 RM 的“Committed”确认消息后，整个 3PC 事务正式结束。</li>
</ol>
<p>如果在预提交阶段有任一 RM 响应“No”或者超时未响应，TM 会向所有 RM 发送“Abort”指令，中断事务。此时中断事务的损失对 RM 来说并不大，因为事务还未进行提交。</p>
<h4 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h4><p>3PC 通过引入预提交阶段，减少了 2PC 中的阻塞问题，并提高了系统的可用性。3PC 的工作流程如下：</p>
<ol>
<li><strong>CanCommit Phase</strong>：确认 RM 的响应能力和是否能够执行事务操作。</li>
<li><strong>PreCommit Phase</strong>：RM 执行本地事务操作，但并不提交，引入超时机制以避免阻塞。</li>
<li><strong>DoCommit Phase</strong>：进行真正的事务提交，确保所有 RM 都成功提交事务。</li>
</ol>
<p>3PC 的优点：</p>
<ul>
<li><strong>减少阻塞</strong>：通过引入预提交阶段，减少了 2PC 中的阻塞问题，提高了系统的可用性。</li>
<li><strong>超时机制</strong>：引入了超时机制，避免了因单点故障导致的事务阻塞。</li>
</ul>
<p>3PC 的缺点：</p>
<ul>
<li><strong>复杂性增加</strong>：相较于 2PC，3PC 的实现更为复杂，增加了系统的复杂性。</li>
<li><strong>性能开销</strong>：由于引入了额外的阶段和超时机制，3PC 的性能开销相对较大。</li>
</ul>
<h2 id="柔性事务"><a href="#柔性事务" class="headerlink" title="柔性事务"></a>柔性事务</h2><p>基于分布式系统的 CAP 理论与 BASE 理论，日常的分布式架构下更多需要保证的是整体系统的可用性，在数据的一致性方面可以进行一定的妥协，更多采用的是“最终一致性”方案，此类方案称为柔性事务。常见的柔性事务解决方案包括 TCC（补偿事务）、消息队列事务（MQ 事务）、Saga 等。</p>
<h3 id="TCC（补偿事务）"><a href="#TCC（补偿事务）" class="headerlink" title="TCC（补偿事务）"></a>TCC（补偿事务）</h3><p>TCC（Try-Confirm-Cancel）是一种补偿型事务模型，它将事务分为三个阶段：尝试阶段（Try Phase）、确认阶段（Confirm Phase）和取消阶段（Cancel Phase）。TCC 通过显式地定义事务的尝试、确认和取消逻辑，来实现分布式事务的最终一致性。</p>
<h4 id="尝试阶段（Try-Phase）"><a href="#尝试阶段（Try-Phase）" class="headerlink" title="尝试阶段（Try Phase）"></a>尝试阶段（Try Phase）</h4><p>尝试阶段的核心目标是尝试执行事务操作，并准备好业务所需的资源。</p>
<p>尝试阶段的工作流程如下：</p>
<ol>
<li><strong>业务检查</strong>：业务系统进行必要的业务检查，确保事务操作可以执行。</li>
<li><strong>资源预留</strong>：业务系统预留必要的资源，如数据库锁、缓存资源等，但并不提交事务。</li>
</ol>
<h4 id="确认阶段（Confirm-Phase）"><a href="#确认阶段（Confirm-Phase）" class="headerlink" title="确认阶段（Confirm Phase）"></a>确认阶段（Confirm Phase）</h4><p>确认阶段的核心目标是确认执行事务操作，并处理尝试阶段预留的业务资源。</p>
<p>确认阶段的工作流程如下：</p>
<ol>
<li><strong>确认执行</strong>：当所有参与者的尝试阶段都执行成功后，事务协调者（Transaction Coordinator, TC）向所有参与者发送确认指令（Confirm）。</li>
<li><strong>资源提交</strong>：参与者接收到确认指令后，提交事务并释放预留的资源。</li>
</ol>
<h4 id="取消阶段（Cancel-Phase）"><a href="#取消阶段（Cancel-Phase）" class="headerlink" title="取消阶段（Cancel Phase）"></a>取消阶段（Cancel Phase）</h4><p>取消阶段的核心目标是取消执行事务操作，并释放尝试阶段预留的资源。</p>
<p>取消阶段的工作流程如下：</p>
<ol>
<li><strong>取消执行</strong>：如果任何一个参与者的尝试阶段执行失败，或者在确认阶段出现失败，事务协调者向所有参与者发送取消指令（Cancel）。</li>
<li><strong>资源释放</strong>：参与者接收到取消指令后，回滚事务并释放预留的资源。</li>
</ol>
<h4 id="失败处理与重试机制"><a href="#失败处理与重试机制" class="headerlink" title="失败处理与重试机制"></a>失败处理与重试机制</h4><p>在 TCC 的确认阶段或取消阶段，如果出现失败，TCC 会记录事务日志并持久化到某种存储介质上，如本地磁盘文件或关系型数据库等。事务日志包含了事务的执行状态。</p>
<p>如果检测到在确认或取消阶段执行事务出现失败状态，TCC 会进行重试该阶段的事务逻辑。重试次数一般为 6 次，若超过重试次数仍然失败，则需要人工介入处理。</p>
<h4 id="事务日志的管理"><a href="#事务日志的管理" class="headerlink" title="事务日志的管理"></a>事务日志的管理</h4><p>事务日志在事务执行成功后可以被删除，以节省资源。事务日志的管理通常由事务协调者负责，确保在事务成功提交后清理相关日志。</p>
<h4 id="业务侵入性"><a href="#业务侵入性" class="headerlink" title="业务侵入性"></a>业务侵入性</h4><p>TCC 不需要依赖于底层的数据库资源，更多地是需要手动实现事务的尝试、确认和取消逻辑，因此属于业务侵入式分布式事务解决方案。开发人员需要在业务代码中显式地实现 TCC 的三个阶段，增加了开发复杂度，但同时也提供了更高的灵活性和控制力。</p>
<h3 id="MQ事务"><a href="#MQ事务" class="headerlink" title="MQ事务"></a>MQ事务</h3><p>消息队列（Message Queue, MQ）事务允许事务流应用将生产、处理、消费消息的整个过程看作是一个原子操作。常见的消息队列系统如 RocketMQ、Kafka、Pulsar、QMQ 等都提供了事务相关的功能。下面以 RocketMQ 为例，详细介绍 MQ 事务的工作原理和处理机制。</p>
<h4 id="RocketMQ-事务消息"><a href="#RocketMQ-事务消息" class="headerlink" title="RocketMQ 事务消息"></a>RocketMQ 事务消息</h4><p>RocketMQ 的事务消息机制采用了类似于两阶段提交（2PC）的流程，确保消息的生产和消费过程的原子性。</p>
<p><img src="https://rocketmq.apache.org/assets/images/%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF2-2673a99678f13a471b8fc0bd4ab3bf3a.png" alt="RocketMQ"></p>
<h5 id="事务消息的基本流程"><a href="#事务消息的基本流程" class="headerlink" title="事务消息的基本流程"></a>事务消息的基本流程</h5><ol>
<li><strong>发送半事务消息</strong>：<ul>
<li>生产者在消息队列中开启一个事务，然后发送“半事务”消息（Half Message）给 RocketMQ 的 Broker。此时，“半事务消息”对于消费者来说是不可见的。</li>
<li>Broker 接收到“半事务消息”后，响应“半事务消息发送成功”信息给生产者。</li>
</ul>
</li>
<li><strong>执行本地事务</strong>：<ul>
<li>生产者收到 Broker 的“发送成功”响应后，开始执行本地事务操作。</li>
<li>根据本地事务的执行状态，生产者决定向 Broker 发送“Commit”或“Rollback”指令。</li>
</ul>
</li>
<li><strong>提交或回滚事务消息</strong>：<ul>
<li>如果生产者发送“Commit”指令，Broker 将“半事务消息”转换为真正的消息，并投递给消费者进行消费。</li>
<li>如果生产者发送“Rollback”指令，Broker 将丢弃该“半事务消息”，不进行投递。</li>
</ul>
</li>
</ol>
<h5 id="失败处理与事务反查机制"><a href="#失败处理与事务反查机制" class="headerlink" title="失败处理与事务反查机制"></a>失败处理与事务反查机制</h5><p>如果在第 4 步，生产者发送“Commit”或“Rollback”消息失败了，RocketMQ 的 Broker 会定期查询生产者对应事务的本地事务执行情况，并根据反查结果决定提交或回滚这个“半事务消息”。</p>
<p>事务反查机制的实现依赖于业务代码实现的对应接口。RocketMQ 提供了事务反查的回调接口，业务系统需要实现该接口，以便 Broker 在需要时查询本地事务的状态。</p>
<h5 id="消息消费失败处理"><a href="#消息消费失败处理" class="headerlink" title="消息消费失败处理"></a>消息消费失败处理</h5><p>如果消息消费失败，RocketMQ 会进入消息重试机制，再次尝试消费消息。如果消息重试超过了最大次数，RocketMQ 会认为这个消费有问题，然后将其放入<strong>死信队列</strong>（Dead Letter Queue, DLQ）中，由人工手动排查处理。</p>
<h4 id="QMQ-事务消息"><a href="#QMQ-事务消息" class="headerlink" title="QMQ 事务消息"></a>QMQ 事务消息</h4><p>QMQ 的事务消息机制相对简单，它借助了数据库自带的事务功能，采用了类似于 eBay 提出的本地消息表方案，将分布式事务拆分成本地事务进行处理。</p>
<h5 id="本地消息表方案"><a href="#本地消息表方案" class="headerlink" title="本地消息表方案"></a>本地消息表方案</h5><ol>
<li><strong>业务操作与消息表写入</strong>：<ul>
<li>业务系统在执行本地事务操作的同时，将消息发送状态写入本地消息表。这两个操作在一个事务中提交，确保业务操作成功时消息表也写入成功。</li>
</ul>
</li>
<li><strong>消息发送</strong>：<ul>
<li>单独起一个线程定时轮询消息表，将未处理的消息发送到消息中间件（如 RocketMQ、Kafka 等）。</li>
<li>消息发送成功后，更新消息状态为成功或直接删除消息。</li>
</ul>
</li>
</ol>
<h5 id="优点与适用场景"><a href="#优点与适用场景" class="headerlink" title="优点与适用场景"></a>优点与适用场景</h5><p>QMQ 的事务消息方案中，即使消息队列挂掉，也不会影响数据库事务的执行，因此更加适应于大多数业务场景。这种方法同样适用于其他消息队列，只是 QMQ 封装得更好，提供了开箱即用的解决方案。</p>
</div>
        </div>
        
        <footer class="kratos-entry-footer clearfix">
            
            
            
                <div class="post-actions text-center clearfix" id="post-actions">
                
                    <a class="donate" href="javascript:;" onclick="krOpenDonateModal()"><i class="fa fa-bitcoin"></i> 打赏</a>
                
                
                    <a class="share" href="javascript:;" onclick="krOpenShareModal()"><i class="fa fa-share-alt"></i> 分享</a>
                
                </div>
            
            <div class="footer-tag clearfix">
                <div class="pull-left">
                <i class="fa fa-tags"></i>
                    <a class="tag-none-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/" rel="tag">分布式事务</a>
                </div>
                <div class="pull-date">
                    <time datetime="2024-10-28T08:01:58.407Z" itemprop="dateModified">最后编辑：2024-10-28</time>
                </div>
            </div>
        </footer>
    </div>
    
        <nav class="navigation post-navigation clearfix" role="navigation">
            
            <div class="nav-previous clearfix">
                <a title=" 分布式-服务治理（下）" href="/2024/10/21/分布式-服务治理（下）/"><i class="fa fa-angle-left"></i> 上一篇</a>
            </div>
            
            
            <div class="nav-next clearfix">
                <a title=" 操作系统-进程管理" href="/2024/10/28/操作系统-进程管理/">下一篇 <i class="fa fa-angle-right"></i></a>
            </div>
            
        </nav>
    
    
</article>

        

            </section>

            
                

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/user.jpg" alt="xiaoyan" loading="lazy" decoding="auto" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center">是一只时时翻垃圾吃的宅子。</p>
    </div>
    <div class="site-meta">
        <a class="meta-item" href="/archives/">
            <span class="title">
                文章
            </span>
            <span class="count">
                42
            </span>
        </a>
        <a class="meta-item" href="/categories/">
            <span class="title">
                分类
            </span>
            <span class="count">
                14
            </span>
        </a>
        <a class="meta-item" href="/tags/">
            <span class="title">
                标签
            </span>
            <span class="count">
                62
            </span>
        </a>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                    <aside id="krw-toc" class="widget widget-kratos-toc clearfix toc-div-class" >
    <div class="photo-background"></div>
    <h4 class="widget-title no-after">
        <i class="fa fa-compass"></i>
        文章目录
        <span class="toc-progress-bar" role="progressbar" aria-label="阅读进度："></span>
    </h4>
    <div class="textwidget">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E4%BA%8B%E5%8A%A1%EF%BC%9F"><span class="toc-number">1.1.</span> <span class="toc-text">为什么需要事务？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.2.</span> <span class="toc-text">数据库事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.1.</span> <span class="toc-text">数据库事务实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">1.2.2.</span> <span class="toc-text">事务隔离级别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">1.3.</span> <span class="toc-text">分布式事务</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">2.</span> <span class="toc-text">分布式事务解决方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9A%E6%80%A7%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.1.</span> <span class="toc-text">刚性事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2PC%EF%BC%88%E4%BA%8C%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E5%8D%8F%E8%AE%AE%EF%BC%89"><span class="toc-number">2.1.1.</span> <span class="toc-text">2PC（二阶段提交协议）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5%EF%BC%88Prepare%EF%BC%89"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">准备阶段（Prepare）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E9%98%B6%E6%AE%B5%EF%BC%88Commit-Phase%EF%BC%89"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">提交阶段（Commit Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">2.1.1.3.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3PC%EF%BC%88%E4%B8%89%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4%E5%8D%8F%E8%AE%AE%EF%BC%89"><span class="toc-number">2.1.2.</span> <span class="toc-text">3PC（三阶段提交协议）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5%EF%BC%88CanCommit-Phase%EF%BC%89"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">准备阶段（CanCommit Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%A2%84%E6%8F%90%E4%BA%A4%E9%98%B6%E6%AE%B5%EF%BC%88PreCommit-Phase%EF%BC%89"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">预提交阶段（PreCommit Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E4%BA%8B%E5%8A%A1%E6%8F%90%E4%BA%A4%E9%98%B6%E6%AE%B5%EF%BC%88DoCommit-Phase%EF%BC%89"><span class="toc-number">2.1.2.3.</span> <span class="toc-text">执行事务提交阶段（DoCommit Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93-1"><span class="toc-number">2.1.2.4.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%94%E6%80%A7%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.2.</span> <span class="toc-text">柔性事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TCC%EF%BC%88%E8%A1%A5%E5%81%BF%E4%BA%8B%E5%8A%A1%EF%BC%89"><span class="toc-number">2.2.1.</span> <span class="toc-text">TCC（补偿事务）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%9D%E8%AF%95%E9%98%B6%E6%AE%B5%EF%BC%88Try-Phase%EF%BC%89"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">尝试阶段（Try Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A1%AE%E8%AE%A4%E9%98%B6%E6%AE%B5%EF%BC%88Confirm-Phase%EF%BC%89"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">确认阶段（Confirm Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%96%E6%B6%88%E9%98%B6%E6%AE%B5%EF%BC%88Cancel-Phase%EF%BC%89"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">取消阶段（Cancel Phase）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86%E4%B8%8E%E9%87%8D%E8%AF%95%E6%9C%BA%E5%88%B6"><span class="toc-number">2.2.1.4.</span> <span class="toc-text">失败处理与重试机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%97%A5%E5%BF%97%E7%9A%84%E7%AE%A1%E7%90%86"><span class="toc-number">2.2.1.5.</span> <span class="toc-text">事务日志的管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%9A%E5%8A%A1%E4%BE%B5%E5%85%A5%E6%80%A7"><span class="toc-number">2.2.1.6.</span> <span class="toc-text">业务侵入性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MQ%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.2.2.</span> <span class="toc-text">MQ事务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RocketMQ-%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">RocketMQ 事务消息</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.2.1.1.</span> <span class="toc-text">事务消息的基本流程</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86%E4%B8%8E%E4%BA%8B%E5%8A%A1%E5%8F%8D%E6%9F%A5%E6%9C%BA%E5%88%B6"><span class="toc-number">2.2.2.1.2.</span> <span class="toc-text">失败处理与事务反查机制</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86"><span class="toc-number">2.2.2.1.3.</span> <span class="toc-text">消息消费失败处理</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#QMQ-%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">QMQ 事务消息</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%B6%88%E6%81%AF%E8%A1%A8%E6%96%B9%E6%A1%88"><span class="toc-number">2.2.2.2.1.</span> <span class="toc-text">本地消息表方案</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%98%E7%82%B9%E4%B8%8E%E9%80%82%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">2.2.2.2.2.</span> <span class="toc-text">优点与适用场景</span></a></li></ol></li></ol></li></ol></li></ol></li></ol>
    </div>
</aside>
                
                
  <aside id="krw-categories" class="widget widget-kratos-categories clearfix">
    <h4 class="widget-title"><i class="fa fa-folder"></i>分类列表</h4>
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">15</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/JVM/">JVM</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/%E5%9F%BA%E7%A1%80/">基础</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">并发编程</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/%E9%9B%86%E5%90%88/">集合</a><span class="category-list-count">5</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9E%B6%E6%9E%84/">架构</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">计算机基础</a><span class="category-list-count">6</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a><span class="category-list-count">5</span></li></ul></li></ul>
  </aside>


            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4>
      <div class="tag-clouds">
        <a href="/tags/AOP/" style="font-size: 0.6em;">AOP</a> <a href="/tags/BASE/" style="font-size: 0.6em;">BASE</a> <a href="/tags/Bean/" style="font-size: 0.6em;">Bean</a> <a href="/tags/CAP/" style="font-size: 0.6em;">CAP</a> <a href="/tags/Cookie/" style="font-size: 0.6em;">Cookie</a> <a href="/tags/DDD/" style="font-size: 0.6em;">DDD</a> <a href="/tags/DNS/" style="font-size: 0.6em;">DNS</a> <a href="/tags/HTTP/" style="font-size: 0.6em;">HTTP</a> <a href="/tags/I-O/" style="font-size: 0.6em;">I/O</a> <a href="/tags/IoC/" style="font-size: 0.6em;">IoC</a> <a href="/tags/JWT/" style="font-size: 0.6em;">JWT</a> <a href="/tags/Java8%E6%96%B0%E7%89%B9%E6%80%A7/" style="font-size: 0.6em;">Java8新特性</a> <a href="/tags/Java%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/" style="font-size: 0.6em;">Java基本概念</a> <a href="/tags/List/" style="font-size: 0.6em;">List</a> <a href="/tags/Map/" style="font-size: 0.8em;">Map</a> <a href="/tags/MyBatis/" style="font-size: 0.6em;">MyBatis</a> <a href="/tags/MySQL%E5%9F%BA%E7%A1%80/" style="font-size: 0.6em;">MySQL基础</a> <a href="/tags/Nginx/" style="font-size: 0.6em;">Nginx</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/2024/10/28/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/"><i class="fa fa-book"></i> 操作系统-进程管理</a>
            
          
        
          
          
            <a class="list-group-item" href="/2024/10/27/%E5%88%86%E5%B8%83%E5%BC%8F-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1/"><i class="fa fa-book"></i> 分布式-分布式事务</a>
            
          
        
          
          
            <a class="list-group-item" href="/2024/10/21/%E5%88%86%E5%B8%83%E5%BC%8F-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%EF%BC%88%E4%B8%8B%EF%BC%89/"><i class="fa fa-book"></i> 分布式-服务治理（下）</a>
            
          
        
          
          
            <a class="list-group-item" href="/2024/10/21/%E5%88%86%E5%B8%83%E5%BC%8F-%E6%9C%8D%E5%8A%A1%E6%B2%BB%E7%90%86%EF%BC%88%E4%B8%8A%EF%BC%89/"><i class="fa fa-book"></i> 分布式-服务治理（上）</a>
            
          
        
          
          
            <a class="list-group-item" href="/2024/10/21/%E5%88%86%E5%B8%83%E5%BC%8F-%E5%9F%BA%E7%A1%80%E7%90%86%E8%AE%BA/"><i class="fa fa-book"></i> 分布式-基础理论&算法</a>
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
      </ul>
  </div>
  </aside>

            
    </div>
</section>
            

        

                </div>
    </div>
</div>

<footer>
    <div id="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2024 XIAOYAN 版权所有.</li>
                            <li>本站已运行<span id="kr-since">Loading...</span></li>
                        </div>
                        <div>
                            <li>自豪地使用 <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a> 主题</li>
                            <li>站点由 xiaoyan 用 <i class="fa fa-heart" style="color:#d43f57"></i> 搭建</li>
                        </div>
                        <!-- 额外的追加注入项 -->
                        
                    </ul>
                </div>
            </div>
        </div>
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                <div class="box theme-box" id="theme-toggle">
                    <span class="fa fa-adjust"></span>
                </div>
            </div>
            <div id="gotop-box" class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
    </div>
</footer>
</div>
</div>


    <div id="kr-donate-modal" class="kr-modal">
    <div class="kr-modal-bg" onclick="krCloseDonateModal()"></div>
    <div class="kr-modal-content">
        <div class="kr-modal-header">
            <div class="kr-modal-icon">
                <i class="fa fa-bitcoin"></i>
            </div>
            <div class="kr-modal-title">打赏</div>
            <button class="kr-modal-close" onclick="krCloseDonateModal()">
                <i class="fa fa-times-circle"></i>
            </button>
        </div>
        <div class="kr-modal-body">
            <div class="kr-donate-message">请我喝一杯冰阔咯~</div>
            <div class="kr-donate-qr" id="kr-donate-qr">
                
            </div>
            <div class="kr-donate-platforms">
                
                    
                        <button class="kr-donate-platform-button" style="color: #1677ff;" title="支付宝" onclick="krDonateModalShowPlatformQR('https://qr.alipay.com/fkx15009k7u0fqrj8auepdf', '#1677ff')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-brand-alipay">
  <path stroke="none" d="M0 0h24v24H0z" fill="none" />
  <path d="M19 3h-14a2 2 0 0 0 -2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2 -2v-14a2 2 0 0 0 -2 -2z" />
  <path d="M7 7h10" />
  <path d="M12 3v7" />
  <path d="M21 17.314c-2.971 -1.923 -15 -8.779 -15 -1.864c0 1.716 1.52 2.55 2.985 2.55c3.512 0 6.814 -5.425 6.814 -8h-6.604" />
</svg>

                        </button>
                    
                
                    
                        <button class="kr-donate-platform-button" style="color: #38ad5a;" title="微信支付" onclick="krDonateModalShowPlatformQR('wxp://f2f0hR4eF9Ypa3tpzjWme9fQDyWW3PIGe3WG5oiIakWLmDs', '#38ad5a')">
                            <i class="fa fa-wechat"></i>
                        </button>
                    
                
            </div>
        </div>
    </div>
</div>
<script defer src="/js/kr-modal/donate.min.js"></script>




    <div id="kr-share-modal" class="kr-modal">
    <div class="kr-modal-bg" onclick="krCloseShareModal()"></div>
    <div class="kr-modal-content">
        <div class="kr-modal-header">
            <div class="kr-modal-icon">
                <i class="fa fa-share-alt"></i>
            </div>
            <div class="kr-modal-title">分享</div>
            <button class="kr-modal-close" onclick="krCloseShareModal()">
                <i class="fa fa-times-circle"></i>
            </button>
        </div>
        <div class="kr-modal-body">
            <div class="kr-share-message">让兄弟萌也来瞅一瞅！</div>
            <div class="kr-share-qr" id="kr-share-qr"></div>
            <div class="kr-share-platforms">
                
                    <button class="kr-share-platform-button" style="color: #e6162d;" title="QQ" onclick="krShareModalOpenPlatform('')">
                        <i class="fa fa-qq"></i>
                    </button>
                
                    <button class="kr-share-platform-button" style="color: #25d366;" title="微信" onclick="krShareModalOpenPlatform('')">
                        <i class="fa fa-weixin"></i>
                    </button>
                
            </div>
        </div>
    </div>
</div>
<script defer src="/js/kr-modal/share.min.js"></script>



<!-- 额外的追加注入项 -->

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<meting-js
  server="netease"
  type="playlist"
  fixed="true"
  order="random"
  id="12613265870">
</meting-js>



        <script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>


  <script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script>



  <script defer src="/vendors/viewerjs@1.11.6/dist/viewer.min.js"></script>


<script defer src="/js/kr-core.min.js"></script>


  <script defer src="/js/kr-pjax.min.js"></script>


<!-- 额外的追加注入项 -->

  <script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>



    </body>
</html>